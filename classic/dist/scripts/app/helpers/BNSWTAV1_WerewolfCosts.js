define(["underscore","parse","backbone","../models/Description"],function(t,e,n,i){var r=n.Collection.extend({model:i}),a=e.Object.extend("WerewolfCosts",{initialize:function(){var t=this;t.descriptions=new r;var n=new e.Query(i).equalTo("category","wta_gifts");return n.each(function(e){t.descriptions.add(e)})},get_affinities:function(t){var e=t.get_affinities();return e},gift_is_affinity:function(e,n){var i=this,r=n.get_base_name(),a=t.find(i.descriptions.models,function(t){return t.get("name")==r});if(!a)return!1;var o=t.without(t.map(t.range(1,4),function(t){var e=a.get("affinity_"+t);if(e)return e}),void 0);console.log(o);var _=i.get_affinities(e),s=t.intersection(o,_);return 0!=s.length},get_cost_table:function(e){return t.map(t.range(1,10),function(t){return t*e})},get_cost_on_table:function(e,n){return t.chain(e).take(n).sum().value()},get_trait_cost_on_table:function(t,e){var n=this,i=e.get("value"),r=e.get("free_value")||0,a=n.get_cost_on_table(t,i),o=n.get_cost_on_table(t,r);return a-o},calculate_trait_cost:function(e,n){var i=this,r=n.get("category"),a=(n.get("name"),n.get("value")),o=n.get("free_value")||0,_=a-o,s=n.get("experience_cost_type"),c=t.parseInt(n.get("experience_cost_modifier"));if("flat"==s)return _*c;if("linear"==s)return i.get_trait_cost_on_table(i.get_cost_table(c),n);if("attributes"==r)return 3*_;if("wta_gifts"==r)return i.gift_is_affinity(e,n)?4*_:6*_;if("wta_merits"==r)return _;if("wta_flaws"==r)return _*-1;if("wta_backgrounds"==r)return i.get_trait_cost_on_table(i.get_cost_table(2),n);var f=e.rank();if("skills"==r){var u;return u=f>=3?i.get_cost_table(2):i.get_cost_table(1),i.get_trait_cost_on_table(u,n)}}});return a});