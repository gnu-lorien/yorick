define(["require","jquery","parse","pretty","jscookie","moment","backbone","../collections/CategoriesCollection","../views/CharactersListView","../models/Vampire","../models/Werewolf","../collections/Vampires","../views/CharacterView","../models/SimpleTrait","../models/VampireCreation","../views/CharacterNewView","../views/CharacterCostsView","../views/SimpleTextNewView","../views/SimpleTraitSpecializationView","../views/CharacterLogView","../views/SignupView","../views/LoginView","../views/CharacterExperienceView","../views/CharacterPortraitView","../views/CharacterDeleteView","../views/PlayerOptionsView","../views/TroupeEditStaffView","../models/Troupe","../helpers/PromiseFailReport","../views/TroupePortraitView","text!../templates/footer.html","../helpers/InjectAuthData","../collections/Patronages","../collections/Users","../models/Patronage","../helpers/UserWreqr","../views/CharacterRenameView","../views/SimpleTraitNewSpecializationView","../views/CharacterCreateSimpleTraitNewView","../models/Werewolf","../views/CharactersSelectToPrintView","../views/CharacterLongTextView","../models/ChangelingBetaSlice"],function(e,t,r,a,i,n,o,c,s,h,l,u,g,d,p,m,f,w,b,v,V,P,y,k,T,C,x,H,S,U,z,N,L,Q,R,I,A,E,q,l,j,B,D){var O=r.Router.extend({initialize:function(){this._character=null,_.bindAll(this,"get_character"),this.characters=new s({el:"#characters-all",collection:new u}),this.troupeCharacters=new s({el:"#troupe-characters-all",collection:new u}),this.characterMainPage=new g({el:"#character"}),this.simpleTextNewView=new w({el:"#simpletext-new"}),this.simpleTraitSpecializationView=new b({el:"#simpletrait-specialization"}),this.simpleTraitNewSpecializationView=new E({el:"#simpletrait-new-specialization"}),this.characterCreateSimpleTraitNewView=new q({el:"#character-create-simpletrait-new"}),this.characterNewView=new m({el:"#character-new-form"}),this.characterCostsView=new f({el:"#character-costs"}),this.characterLogView=new v({el:"#character-log"}),this.characterExperienceView=new y({el:"#experience-notations-all"}),this.characterPortraitView=new k({el:"#character-portrait"}),this.characterDeleteView=new T({el:"#character-delete"}),this.loginView=new P,this.signupView=new V,r.history.start()},routes:{"":"home",start:"home",about:"about",privacy:"privacy_policy",logout:"logout",signup:"signup",reset:"resetpassword",profile:"profile","patronage/:id":"a_patronage","category?:type":"category","victims?:type":"victims","characters?:type":"characters","character?:id":"character","simpletraits/:category/:cid/:type":"simpletraits","simpletrait/:category/:cid/:bid":"simpletrait","simpletrait/specialize/:category/:cid/:bid":"simpletraitspecialize","simpletrait/spacer/:category/:cid/:name/:value/:free_value/new":"simpletraitnew","simpletrait/specialize/:category/:cid/:name/:value/:free_value/new":"simpletrait_new_specialize","simpletext/:category/:target/:cid/pick":"simpletextpick","simpletext/:category/:target/:cid/unpick":"simpletextunpick","charactercreate/:cid":"charactercreate","charactercreate/simpletraits/:category/:cid/pick/:i":"charactercreatepicksimpletrait","charactercreate/simpletraits/:category/:cid/unpick/:stid/:i":"charactercreateunpicksimpletrait","charactercreate/simpletraits/:category/:cid/specialize/:stid/:i":"charactercreatespecializesimpletrait","charactercreate/simpletext/:category/:target/:cid/pick":"charactercreatepicksimpletext","charactercreate/simpletext/:category/:target/:cid/unpick":"charactercreateunpicksimpletext","charactercreate/complete/:cid":"charactercreatecomplete",characternew:"characternew","character/:cid/print":"characterprint","character/:cid/costs":"charactercosts","character/:cid/log/:start/:changeBy":"characterlog","character/:cid/history/:id":"characterhistory","character/:cid/portrait":"characterportrait","character/:cid/delete":"characterdelete","character/:cid/troupes":"character_list_troupes","character/:cid/troupes/leave":"character_pick_troupe_to_leave","character/:cid/troupes/join":"character_pick_troupe_to_join","character/:cid/troupe/:tid/join":"character_join_troupe","character/:cid/troupe/:tid/leave":"character_leave_troupe","character/:cid/troupe/:tid/show":"character_show_troupe","character/:cid/approval":"characterapproval","character/:cid/rename":"characterrename","character/:cid/approved":"character_show_approved","character/:cid/extendedprinttext":"character_extended_print_text","character/:cid/backgroundlt":"character_background_long_text","character/:cid/noteslt":"character_notes_long_text","character/:cid/experience/:start/:changeBy":"characterexperience","troupe/new":"troupenew",troupes:"troupes","troupe/:id":"troupe","troupe/:id/staff/add":"troupeaddstaff","troupe/:id/staff/edit/:uid":"troupeeditstaff","troupe/:id/characters/:type":"troupecharacters","troupe/:id/characters/summarize/:type":"troupesummarizecharacters","troupe/:id/characters/selecttoprint/:type":"troupe_select_to_print_characters","troupe/:id/characters/print/:type":"troupe_print_characters","troupe/:id/characters/relationships/network":"troupe_relationship_network","troupe/:id/character/:cid":"troupe_character","troupe/:id/portrait":"troupe_portrait",administration:"administration","administration/characters/all":"administration_characters_all","administration/characters/summarize":"administration_characters_summarize","administration/character/:id":"administration_character","administration/users/all":"administration_users","administration/user/:id":"administration_user","administration/patronages/user/:id":"administration_user_patronages","administration/patronages":"administration_patronages","administration/patronagescsv":"administration_patronages_csv","administration/patronage/:id":"administration_patronage","administration/patronages/new":"administration_patronage_new","administration/patronages/new/:userid":"administration_patronage_new","administration/descriptions":"administration_descriptions","administration/bnsctdbs_kith_rules":"administration_bnsctdbs_kith_rules",referendums:"referendums","referendum/:id":"referendum","administration/referendums":"administration_referendums","administration/referendum/:id":"administration_referendum"},home:function(){var e=this;this.enforce_logged_in().then(function(){var e=new r.Query(r.Role).equalTo("users",r.User.current());return e.count()}).then(function(e){var t=r.User.current();return 0<e?t.set("storytellerinterface",!0):t.set("storytellerinterface",!1),N(t),t.save()}).then(function(){e.playerOptionsView=e.playerOptionsView||new C({el:"#player-options"}).setup(),t.mobile.changePage("#player-options",{reverse:!1,changeHash:!1})}).fail(S)},logout:function(){r.User.logOut().always(function(){return hello("facebook").logout()}).always(function(){window.location.hash="",window.location.reload()})},signup:function(){r.User.current()?window.location.hash="":t.mobile.changePage("#signup",{reverse:!1,changeHash:!1})},about:function(){t.mobile.changePage("#about",{reverse:!1,changeHash:!1})},privacy_policy:function(){var r=this;e(["../views/PrivacyPolicyView"],function(e){r.privacyPolicyView=r.privacyPolicyView||new e({el:"#privacy"}),r.privacyPolicyView.render(),t.mobile.changePage("#privacy",{reverse:!1,changeHash:!1})})},resetpassword:function(){var r=this;e(["../views/PasswordReset"],function(e){r.resetPasswordView=r.resetPasswordView||new e({el:"#user-reset-password"}),r.resetPasswordView.render(),t.mobile.changePage("#user-reset-password",{reverse:!1,changeHash:!1})})},profile:function(){var r=this;t.mobile.loading("show"),r.set_back_button("#"),e(["../views/UserSettingsProfileView"],function(e){r.enforce_logged_in().then(function(){return I.get_users()}).then(function(){r.userSettingsProfileView=r.userSettingsProfileView||(new e).setup(),t.mobile.changePage("#user-settings-profile",{reverse:!1,changeHash:!1})})})},a_patronage:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#profile"),e(["../views/PatronageView"],function(e){i.enforce_logged_in().then(function(){return r.Promise.when(i.get_patronage(a),I.get_users())}).then(function(r,a){i.administrationPatronageView&&i.administrationPatronageView.remove(),i.administrationPatronageView=new e({model:r}),i.administrationPatronageView.render(),t("#administration-patronage-view").find("div[role='main']").append(i.administrationPatronageView.el),t.mobile.changePage("#administration-patronage-view",{reverse:!1,changeHash:!1})}).fail(S).fail(function(){t.mobile.loading("hide")})})},set_back_button:function(e){t("#header-back-button").attr("href",e)},charactercosts:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.get_character(e,["skills","disciplines","backgrounds"]).done(function(e){r.characterCostsView.model=e,r.characterCostsView.render(),t.mobile.changePage("#character-costs",{reverse:!1,changeHash:!1})})},characterlog:function(e,r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#character?"+e),i.get_character(e,"all").done(function(e){i.characterLogView.register(e,r,a);t(".ui-page-active").attr("id"),t.mobile.changePage("#character-log",{reverse:!1,changeHash:!1});t.mobile.loading("hide")})},characterexperience:function(e,r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#character?"+e),i.get_character(e,"all").done(function(e){i.characterExperienceView.register(e,r,a);t(".ui-page-active").attr("id"),t.mobile.changePage("#experience-notations-all",{reverse:!1,changeHash:!1});t.mobile.loading("hide")})},characterhistory:function(r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#character?"+r),e(["../views/CharacterHistoryView"],function(e){i.get_character(r,"all").then(function(t){return i.characterHistoryView=i.characterHistoryView||new e({el:"#character-history"}),i.characterHistoryView.register(t,a)}).then(function(){t(".ui-page-active").attr("id"),t.mobile.changePage("#character-history",{reverse:!1,changeHash:!1});t.mobile.loading("hide")}).fail(S)})},characterapproval:function(r){var a=this;t.mobile.loading("show"),a.set_back_button("#character?"+r),e(["../views/CharacterApprovalView"],function(e){a.get_character(r,"all").then(function(e){return e.fetch_long_text("extended_print_text")}).then(function(t){return a.characterApprovalView=a.characterApprovalView||new e({el:"#character-approval > div[role='main']"}),a.characterApprovalView.register(t)}).then(function(){t(".ui-page-active").attr("id"),t.mobile.changePage("#character-approval",{reverse:!1,changeHash:!1});t.mobile.loading("hide")}).fail(S)})},withCharacterCreateView:function(){var t=this,a=new r.Promise;return e(["../views/CharacterCreateViewNew"],function(e){t.characterCreateView=t.characterCreateView||new e({el:"#character-create"}),a.resolve(t.characterCreateView)}),a},withCharacterPrintView:function(t){var r=this;e(["../views/CharacterPrintView"],function(e){r.characterPrintView=r.characterPrintView||new e({el:"#printable-sheet"}),t()})},character_show_approved:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.withCharacterPrintView(function(){r.get_character(e,"all").then(function(e){return e.fetch_long_text("extended_print_text")}).then(function(e){return e.get_transformed_last_approved()}).then(function(e){null==e?t.mobile.changePage("#character-print-no-approval",{reverse:!1,changeHash:!1}):(e.transform_description=[],r.characterPrintView.setup({character:e}),t.mobile.changePage("#printable-sheet",{reverse:!1,changeHash:!1}))}).fail(S)})},characterrename:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.get_character(e,"all").then(function(e){return r.characterRenameView=r.characterRenameView||new A({el:"#character-rename-main"}),r.characterRenameView.register(e)}).then(function(){t.mobile.changePage("#character-rename",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)},characterprint:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.withCharacterPrintView(function(){r.get_character(e,"all").then(function(e){return e.fetch_long_text("extended_print_text")}).then(function(e){e.transform_description=[],r.characterPrintView.setup({character:e}),t.mobile.changePage("#printable-sheet",{reverse:!1,changeHash:!1})}).fail(S)})},characternew:function(){var e=this;t.mobile.loading("show"),e.set_back_button("#characters?all"),e.characterNewView.render(),t.mobile.changePage("#character-new",{reverse:!1,changeHash:!1})},charactercreate:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.withCharacterCreateView().then(function(){return r.get_character(e,[])}).then(function(e){return e.fetch_all_creation_elements()}).then(function(e){r.characterCreateView.setup({character:e}),r.characterCreateView.scroll_back_after_page_change(),t.mobile.changePage("#character-create",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)},charactercreatepicksimpletrait:function(e,r,a){var i=this;a=_.parseInt(a),t.mobile.loading("show"),i.set_back_button("#charactercreate/"+r),i.withCharacterCreateView().then(function(){return i.get_character(r,[e])}).done(function(t){var r;return"disciplines"==e?r="in clan disciplines":"wta_gifts"==e&&(r=["affinity","show_only_value_1"]),i.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,i.characterCreateSimpleTraitNewView.register(t,e,a,"#charactercreate/<%= self.character.id %>",r,"#charactercreate/simpletraits/<%= self.category %>/<%= self.character.id %>/specialize/<%= b.linkId() %>/"+a)}).then(function(){t.mobile.changePage("#character-create-simpletrait-new",{reverse:!1,changeHash:!1})})},charactercreatespecializesimpletrait:function(e,r,a,i){var n=this;i=_.parseInt(i),t.mobile.loading("show"),n.set_back_button("#charactercreate/"+r),n.get_character(r,[e]).then(function(t){return t.get_trait(e,a)}).then(function(t,r){return n.simpleTraitSpecializationView.register(r,t,e,window.location.hash,"#charactercreate/"+r.id)}).then(function(){t.mobile.changePage("#simpletrait-specialization",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},charactercreateunpicksimpletrait:function(e,r,a,i){var n=this;i=_.parseInt(i),t.mobile.loading("show"),n.set_back_button("#charactercreate/"+r),n.withCharacterCreateView().then(function(){return n.get_character(r,[e])}).then(function(t){return n.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,t.unpick_from_creation(e,a,i)}).done(function(e){window.location.hash="#charactercreate/"+e.id}).fail(function(e){console.log(e.message)})},charactercreatepicksimpletext:function(e,r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#charactercreate/"+a),i.withCharacterCreateView().then(function(){return i.get_character(a,[e])}).then(function(t){return i.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,i.simpleTextNewView.register(t,e,r,"#charactercreate/"+t.id)}).then(function(){t.mobile.changePage("#simpletext-new",{reverse:!1,changeHash:!1})})},charactercreateunpicksimpletext:function(e,r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#charactercreate/"+a),i.get_character(a,[e]).then(function(e){return i.character.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.unpick_text(r)}).then(function(e){window.location.hash="#charactercreate/"+e.id}).fail(S)},charactercreatecomplete:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#charactercreate/"+e),r.get_character(e).done(function(e){return e.complete_character_creation()}).then(function(){window.location.hash="#character?"+e}).fail(function(t){alert(t.message),window.location.hash="#charactercreate/"+e}).fail(S)},characterportrait:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.get_character(e).done(function(e){return r.characterPortraitView.register(e)}).always(function(){t.mobile.changePage("#character-portrait",{reverse:!1,changeHash:!1})})},character_extended_print_text:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.get_character(e,"all").then(function(e){return e.fetch_long_text("extended_print_text")}).then(function(e){e.transform_description=[],r.cept=r.cept||new B({el:"#extended-print-text"}),r.cept.setup(e,{category:"extended_print_text",pretty:"Extended Print Text",description:"Additional text to display with your printed character sheet."}),t.mobile.changePage("#extended-print-text",{reverse:!1,changeHash:!1})}).fail(S)},character_background_long_text:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.get_character(e,"all").then(function(e){return e.fetch_long_text("background")}).then(function(e){e.transform_description=[],r.clt=r.clt||new B({el:"#long-text"}),r.clt.setup(e,{category:"background",pretty:"Background",description:"History and backstory for your character."}),t.mobile.changePage("#long-text",{reverse:!1,changeHash:!1})}).fail(S).always(function(){t.mobile.loading("hide")})},character_notes_long_text:function(e){var r=this;t.mobile.loading("show"),r.set_back_button("#character?"+e),r.get_character(e,"all").then(function(e){return e.fetch_long_text("notes")}).then(function(e){e.transform_description=[],r.clt=r.clt||new B({el:"#long-text"}),r.clt.setup(e,{category:"notes",pretty:"Notes",description:"Notes about your character's interactions and progression"}),t.mobile.changePage("#long-text",{reverse:!1,changeHash:!1})}).fail(S).always(function(){t.mobile.loading("hide")})},show_character_helper:function(e,r){var a=this;t.mobile.loading("show"),a.set_back_button(r),a.get_character(e).done(function(e){a.characterMainPage.model=e,a.characterMainPage.render(),a.characterMainPage.scroll_back_after_page_change(),t.mobile.changePage("#character",{reverse:!1,changeHash:!1})}).then(function(){t.mobile.loading("hide")}).fail(S).fail(function(){window.location.hash=r})},character:function(e){this.show_character_helper(e,"#characters?all")},troupe_character:function(e,t){this.show_character_helper(t,"#troupe/"+e+"/characters/all")},administration_character:function(e){this.show_character_helper(e,"#administration/characters/all")},administration_users:function(){var a=this;t.mobile.loading("show"),a.set_back_button("#administration"),e(["../views/UsersView"],function(e){a.enforce_logged_in().then(function(){var i=r.User.current().get("admininterface");i&&(a.troupeAddStaffView=a.troupeAddStaffView||new e({el:"#troupe-add-staff"}),a.troupeAddStaffView.register("#administration/user/<%= id %>"),t.mobile.changePage("#troupe-add-staff",{reverse:!1,changeHash:!1}))}).always(function(){t.mobile.loading("hide")})})},administration_user:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#administration/users/all"),e(["../views/AdministrationUserView"],function(e){i.enforce_logged_in().then(function(){return r.Promise.when(new r.Query("User").get(a),i.get_patronages(),I.get_users())}).then(function(n,o,c){var s=r.User.current().get("admininterface");if(s){var h=_.select(o.models,"attributes.owner.id",a);i.administrationUserView=i.administrationUserView||new e({patronages:o}),i.administrationUserView.register(n),i.administrationUserView.patronages.reset(h),t.mobile.changePage("#administration-user-view",{reverse:!1,changeHash:!1})}}).always(function(){t.mobile.loading("hide")}).fail(S)})},administration_user_patronages:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#administration/users/all"),e(["../views/AdministrationUserView"],function(e){i.enforce_logged_in().then(function(){return new r.Query("User").get(a)}).then(function(a){var n=r.User.current().get("admininterface");n&&(i.administrationUserPatronagesView=i.administrationUserPatronagesView||new e({el:"#administration-user-patronages-view"}),i.administrationUserPatronagesView.register(a),t.mobile.changePage("#administration-user-patronages-view",{reverse:!1,changeHash:!1}))}).always(function(){t.mobile.loading("hide")}).fail(S)})},administration_patronages:function(){var a=this;t.mobile.loading("show"),a.set_back_button("#administration"),e(["../views/PatronagesView"],function(e){a.enforce_logged_in().then(function(){return r.Promise.when(a.get_patronages(),I.get_users())}).then(function(i,n){var o=r.User.current().get("admininterface");o&&(a.administrationPatronagesView=a.administrationPatronageView||new e({el:"#administration-patronages-view-list",collection:i,back_url_base:"#administration/patronage/"}).render(),t.mobile.changePage("#administration-patronages-view",{reverse:!1,changeHash:!1}))}).fail(S).fail(function(){t.mobile.loading("hide")})})},administration_patronages_csv:function(){var a=this;t.mobile.loading("show"),a.set_back_button("#administration"),e(["../views/PatronagesCSVView"],function(e){a.enforce_logged_in().then(function(){return r.Promise.when(a.get_patronages(),I.get_users())}).then(function(i,n){var o=r.User.current().get("admininterface");o&&(a.administrationPatronagesCSVView=a.administrationPatronageCSVView||new e({el:"#administration-patronages-view-csv-list",collection:i}).render(),t.mobile.changePage("#administration-patronages-view-csv",{reverse:!1,changeHash:!1}))}).fail(S).fail(function(){t.mobile.loading("hide")})})},administration_patronage:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#administration/patronages"),e(["../views/PatronageView"],function(e){i.enforce_logged_in().then(function(){return r.Promise.when(i.get_patronage(a),I.get_users())}).then(function(r,a){i.administrationPatronageView&&i.administrationPatronageView.remove(),i.administrationPatronageView=new e({model:r}),i.administrationPatronageView.render(),t("#administration-patronage-view").find("div[role='main']").append(i.administrationPatronageView.el),t.mobile.changePage("#administration-patronage-view",{reverse:!1,changeHash:!1})}).fail(S).fail(function(){t.mobile.loading("hide")})})},administration_patronage_new:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#administration/patronages"),e(["../views/PatronageView"],function(e){i.enforce_logged_in().then(function(){return r.Promise.when(new R,I.get_users())}).then(function(r,n){i.administrationPatronageView&&i.administrationPatronageView.remove(),r.set("owner",n.get(a)),i.administrationPatronageView=new e({model:r}),i.administrationPatronageView.render(),t("#administration-patronage-view").find("div[role='main']").append(i.administrationPatronageView.el),t.mobile.changePage("#administration-patronage-view",{reverse:!1,changeHash:!1})}).fail(S).fail(function(){t.mobile.loading("hide")})})},administration_descriptions:function(){var r=this;r.set_back_button("#administration"),t.mobile.loading("show"),e(["../views/DescriptionsView"],function(e){r.enforce_logged_in().then(function(){return r.administrationDescriptionsView=r.administrationDescriptionsView||(new e).setup(),r.administrationDescriptionsView.update_categories()}).then(function(){t.mobile.changePage("#administration-descriptions",{reverse:!1,changeHash:!1})}).fail(function(){t.mobile.loading("hide")}).fail(S)})},administration_bnsctdbs_kith_rules:function(){var r=this;r.set_back_button("#administration"),t.mobile.loading("show"),e(["../views/BNSCTDBSKithRules"],function(e){r.enforce_logged_in().then(function(){return r.administrationBNSCTDBSKithRules=r.administrationBNSCTDBSKithRules||(new e).setup(),r.administrationBNSCTDBSKithRules.update_categories()}).then(function(){t.mobile.changePage("#administration-descriptions",{reverse:!1,changeHash:!1})}).fail(function(){t.mobile.loading("hide")}).fail(S)})},characterdelete:function(e){var r=this;t.mobile.loading("show"),this.set_back_button("#character?"+e),r.get_character(e).done(function(e){r.characterDeleteView.register(e,"#characters?all",function(){return r.characters.collection.fetch({reset:!0})}),t.mobile.changePage("#character-delete",{reverse:!1,changeHash:!1})})},get_user_characters:function(){var e=this,t=[];"devuser"==r.User.current().get("username")&&(t.sortbycreated=!0);var a=r.Promise.as([]),i=new r.Query(h);return i.equalTo("owner",r.User.current()),i.include("portrait"),a=i.each(function(e){t.push(e)}).then(function(){e.characters.collection.reset(t)}),a.done(function(){return r.Promise.as(e.characters.collection)})},get_troupe_characters:function(e,t){var a=this;t=_.defaults({},t,{includedeleted:!1});var i=[];"devuser"==r.User.current().get("username")&&(i.sortbycreated=!0);var n=r.Promise.as([]),o=new r.Query(h);return o.equalTo("troupes",e),o.include("portrait"),o.include("owner"),n=o.each(function(e){var r=!0;console.log(JSON.stringify(t)),t.includedeleted||e.has("owner")||(r=!1),r&&i.push(e)}).then(function(){a.troupeCharacters.collection.reset(i)}),n.done(function(){return r.Promise.as(a.troupeCharacters.collection)})},get_troupe_summarize_characters:function(e,a){var i=[];"devuser"==r.User.current().get("username")&&(i.sortbycreated=!0);var n=r.Promise.as([]),o=new r.Query(l);o.equalTo("troupes",e),o.include("portrait"),o.include("owner"),o.equalTo("type","Werewolf"),_.each(l.all_simpletrait_categories(),function(e){o.include(e[0])}),t.mobile.loading("show",{text:"Fetching all characters",textVisible:!0}),n=o.each(function(e){return i.push(e),e.get_long_text("extended_print_text")});var c=new r.Query(h);return c.equalTo("troupes",e),c.include("portrait"),c.include("owner"),c.notEqualTo("type","Werewolf"),_.each(h.all_simpletrait_categories(),function(e){c.include(e[0])}),n=n.then(function(){return c.each(function(e){return i.push(e),e.get_long_text("extended_print_text")})}),n=n.then(function(){t.mobile.loading("show",{text:"Updating local character list",textVisible:!0}),a.reset(i)}),n.done(function(){return t.mobile.loading("show",{text:"Transitioning",textVisible:!0}),r.Promise.as(a)})},get_administrator_characters:function(){var e=this,t=[];"devuser"==r.User.current().get("username")&&(t.sortbycreated=!0);var a=r.Promise.as([]),i=new r.Query(l);i.exists("owner"),i.include("portrait"),i.include("owner"),i.equalTo("type","Werewolf"),a=i.each(function(e){t.push(e)});var n=new r.Query(h);return n.exists("owner"),n.include("portrait"),n.include("owner"),n.notEqualTo("type","Werewolf"),a=a.then(function(){return n.each(function(e){t.push(e)})}),a=a.then(function(){e.characters.collection.reset(t)}),a.done(function(){return r.Promise.as(e.characters.collection)})},get_administrator_summarize_characters:function(){var e=this,t=[];"devuser"==r.User.current().get("username")&&(t.sortbycreated=!0);var a=r.Promise.as([]),i=new r.Query(h);return i.exists("owner"),i.include("portrait"),i.include("owner"),_.each(h.all_simpletrait_categories(),function(e){i.include(e[0])}),_.each(l.all_simpletrait_categories(),function(e){i.include(e[0])}),a=i.each(function(e){t.push(e)}).then(function(){e.characters.collection.reset(t)}),a.done(function(){return r.Promise.as(e.characters.collection)})},get_patronages:function(){var e=this,t=t||{};return _.defaults(t,{update:!0}),e.patronages=e.patronages||new L,e.patronages.fetch()},get_patronage:function(e){var t=this;if(!e)return r.Promise.as(new R);if(_.has(t,"patronages")){var a=t.patronages.get(e);if(a)return r.Promise.as(a)}return new r.Query("Patronage").get(e)},characters:function(e){var r=this;"all"==e&&(r.set_back_button("#"),t.mobile.loading("show"),r.enforce_logged_in().then(function(){return r.get_user_characters()}).then(function(e){r.characters.register("#character?<%= character_id %>"),t.mobile.changePage("#characters-all",{reverse:!1,changeHash:!1})}).fail(S).fail(function(){t.mobile.loading("hide")}))},enforce_logged_in:function(){var e=this;if(!r.User.current()){t.mobile.changePage("#login",{reverse:!1,changeHash:!1}),t.mobile.loading("hide");var a=new r.Error(r.Error.USERNAME_MISSING,"Not logged in");return r.Promise.error(a)}var i=r.User.current();t("#header-logout-button").attr("href","#logout"),t("#header-logout-button").text("Log Out "+i.get("username")),e.footerTemplate=_.template(z)(),t('div[data-role="footer"] > div[data-role="navbar"]').html(e.footerTemplate).trigger("create"),"undefined"!=typeof trackJs?trackJs.configure({userId:i.get("username"),sessionId:i.getSessionToken()}):console.log("Something is blocking trackJs. No user debugging available.");var n=!0;if(e.lastadminchecktime){var o=new Date,c=o-e.lastadminchecktime;c<3e5&&(n=!1)}if(n){e.lastadminchecktime=new Date;var s=new r.Query(r.Role).equalTo("users",r.User.current()).equalTo("name","Administrator"),h=new r.Query(r.Role).equalTo("users",r.User.current()).equalTo("name","SiteAdministrator"),l=r.Query.or(s,h);return l.count().then(function(e){var t=!!e,a=r.User.current();return a.get("admininterface")!=t?(a.set("admininterface",t),N(a),a.save()):r.Promise.as(r.User.current())})}return r.Promise.as(r.User.current())},get_character:function(e,t){var r=this;return r.enforce_logged_in().then(function(){return r._get_character(e,t)})},_check_character_mismatch:function(e){var a=e.get("owner");return _.isUndefined(a)||a.id==r.User.current().id?r.Promise.as(e):e.check_server_client_permissions_mismatch().then(function(){return e.is_mismatched?(t.mobile.loading("show",{text:"Server data mismatch. Attempting to correct.",textVisible:!0}),e.update_troupe_acls()):r.Promise.as(e)})},_get_character:function(e,t){var a=this;if(a.last_fetched_character_id==e){var i;return i="Werewolf"==a.last_fetched_character_type?l.get_character(e,t,a):"ChangelingBetaSlice"==a.last_fetched_character_type?D.get_character(e,t,a):h.get_character(e,t,a),i.then(a._check_character_mismatch)}var n=new r.Query("Vampire").select("type");return n.get(e).then(function(r){return a.last_fetched_character_id=e,a.last_fetched_character_type=r.get("type"),"Werewolf"==r.get("type")?l.get_character(e,t,a):"ChangelingBetaSlice"==r.get("type")?D.get_character(e,t,a):h.get_character(e,t,a)}).then(a._check_character_mismatch)},withSimpleTraitChangeView:function(t){var r=this;e(["../views/SimpleTraitChangeView"],function(e){r.simpleTraitChangeView=r.simpleTraitChangeView||new e({el:"#simpletrait-change"}),t()})},simpletrait:function(e,r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#simpletraits/"+e+"/"+r+"/all"),i.withSimpleTraitChangeView(function(){i.get_character(r,[e]).done(function(t){return t.get_trait(e,a)}).then(function(r,a){i.simpleTraitChangeView.register(a,r,e),t.mobile.changePage("#simpletrait-change",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})})},simpletraitspecialize:function(e,r,a){var i=this;i.set_back_button("#simpletraits/"+e+"/"+r+"/all"),i.get_character(r,[e]).done(function(t){return character=t,character.get_trait(e,a)}).then(function(t,r){return i.simpleTraitSpecializationView.register(r,t,e,"#simpletraits/<%= self.category %>/<%= self.character.id %>/all","#simpletraits/<%= self.category %>/<%= self.character.id %>/all")}).then(function(){t.mobile.changePage("#simpletrait-specialization",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletraitnew:function(e,r,a,i,n){var o=this;t.mobile.loading("show"),o.set_back_button("#simpletraits/"+e+"/"+r+"/all"),o.withSimpleTraitChangeView(function(){o.get_character(r,[e]).then(function(r){var c=new d({name:decodeURIComponent(a),value:_.parseInt(i),free_value:_.parseInt(n),category:e});o.simpleTraitChangeView.register(r,c,e),t.mobile.changePage("#simpletrait-change",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})})},simpletrait_new_specialize:function(e,r,a,i,n){var o=this;o.set_back_button("#simpletraits/"+e+"/"+r+"/all"),o.get_character(r,[e]).then(function(t){var c=new d({name:decodeURIComponent(a),value:_.parseInt(i),free_value:_.parseInt(n)});return o.simpleTraitNewSpecializationView.register(c,e,"#simpletraits/<%= self.category %>/"+r+"/all","#simpletrait/spacer/<%= self.category %>/"+r+"/<%= b.get('name') %>/<%= b.get('value') %>/<%= b.get('free_value') %>/new")}).then(function(){t.mobile.changePage("#simpletrait-new-specialization",{
reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletextpick:function(e,r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#character?"+a),i.get_character(a,[e]).then(function(t){return i.character.backToTop=document.documentElement.scrollTop||document.body.scrollTop,i.simpleTextNewView.register(t,e,r,"#character?"+t.id)}).then(function(){t.mobile.changePage("#simpletext-new",{reverse:!1,changeHash:!1})})},simpletextunpick:function(e,r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#character?"+a),i.get_character(a,[e]).then(function(e){return i.character.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.unpick_text(r)}).then(function(e){window.location.hash="#character?"+e.id}).fail(S)},simpletraits:function(r,a,i){var n=this;"all"==i&&(t.mobile.loading("show"),n.set_back_button("#character?"+a),e(["../views/SimpleTraitCategoryView"],function(e){n.get_character(a,[r]).done(function(a){n.simpleTraitCategoryView=n.simpleTraitCategoryView||new e({el:"#simpletraitcategory-all"}),n.simpleTraitCategoryView.register(a,r),t.mobile.changePage("#simpletraitcategory-all",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})})),"new"==i&&(t.mobile.loading("show"),n.set_back_button("#simpletraits/"+r+"/"+a+"/all"),e(["../views/SimpleTraitNewView"],function(e){n.simpleTraitNewView=n.simpleTraitNewView||new e({el:"#simpletrait-new > div[role='main']"}),n.get_character(a,[r]).done(function(e){return n.simpleTraitNewView.register(e,r)}).then(function(){t.mobile.changePage("#simpletrait-new",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})}))},victims:function(e){"all"==e&&t.mobile.changePage("#victims-all",{reverse:!1,changeHash:!1})},category:function(e){var r=this[e+"View"];r.collection.length?t.mobile.changePage("#"+e,{reverse:!1,changeHash:!1}):(t.mobile.loading("show"),r.collection.fetch().done(function(){t.mobile.changePage("#"+e,{reverse:!1,changeHash:!1})}))},character_list_troupes:function(r){var a=this;t.mobile.loading("show"),a.set_back_button("#character?"+r),e(["../views/TroupesListView"],function(e){a.get_character(r).then(function(t){return a.characterListTroupesView=a.characterListTroupesView||new e({el:"#character-pick-troupe-to-show"}).render(),a.characterListTroupesView.register("#character/"+r+"/troupe/<%= troupe_id %>/show",function(e){e.containedIn("objectId",t.get_troupe_ids())})}).then(function(){t.mobile.changePage("#character-pick-troupe-to-show",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)})},character_pick_troupe_to_leave:function(r){var a=this;t.mobile.loading("show"),a.set_back_button("#character?"+r),e(["../views/TroupesListView"],function(e){a.get_character(r).then(function(t){return a.characterPickTroupeToLeaveView=a.characterPickTroupeToLeaveView||new e({el:"#character-pick-troupe-to-leave"}).render(),a.characterPickTroupeToLeaveView.register("#character/"+r+"/troupe/<%= troupe_id %>/leave",function(e){e.containedIn("objectId",t.get_troupe_ids())})}).then(function(){t.mobile.changePage("#character-pick-troupe-to-leave",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)})},character_pick_troupe_to_join:function(r){var a=this;t.mobile.loading("show"),a.set_back_button("#character?"+r),e(["../views/TroupesListView"],function(e){a.get_character(r).then(function(t){return a.characterPickTroupeToJoinView=a.characterPickTroupeToJoinView||new e({el:"#character-pick-troupe-to-join"}).render(),a.characterPickTroupeToJoinView.register("#character/"+r+"/troupe/<%= troupe_id %>/join",function(e){e.notContainedIn("objectId",t.get_troupe_ids())})}).then(function(){t.mobile.changePage("#character-pick-troupe-to-join",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)})},character_show_troupe:function(r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#character?"+r),e(["../views/TroupeView"],function(e){var n,o;i.get_character(r).then(function(e){n=e;var t=new H({id:a});return t.fetch()}).then(function(r){o=r,i.troupeView=i.troupeView||new e({el:"#troupe"}),i.troupeView.register(o),t.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).fail(function(){window.location.hash="#character?"+r}).always(function(){t.mobile.loading("hide")}).fail(S)})},character_join_troupe:function(r,a){var i=this;t.mobile.loading("show"),i.set_back_button("#character?"+r),e(["../views/TroupeView"],function(e){var n,o;i.get_character(r).then(function(e){n=e;var t=new H({id:a});return t.fetch()}).then(function(e){return o=e,n.join_troupe(e)}).then(function(){i.troupeView=i.troupeView||new e({el:"#troupe"}),i.troupeView.register(o),t.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).fail(function(){window.location.hash="#character?"+r}).always(function(){t.mobile.loading("hide")}).fail(S)})},character_leave_troupe:function(e,r){var a=this;t.mobile.loading("show"),a.set_back_button("#character?"+e);var i,n;a.get_character(e).then(function(e){i=e;var t=new H({id:r});return t.fetch()}).then(function(e){return n=e,i.leave_troupe(e)}).always(function(){window.location.hash="#character?"+e,t.mobile.loading("hide")}).fail(S)},troupecharacters:function(e,a){var i=this;t.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+e);var t=new r.Query("Troupe").include("portrait").get(e);return t}).then(function(e,t){return i.get_troupe_characters(e)}).then(function(){i.troupeCharacters=i.troupeCharacters||new s({el:"#troupe-characters-all",collection:new u}),i.troupeCharacters.register("#troupe/"+e+"/character/<%= character_id %>"),t.mobile.changePage("#troupe-characters-all",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)},troupesummarizecharacters:function(a,i){var n=this;t.mobile.loading("show"),n.set_back_button("#troupe/"+a),e(["../views/CharactersSummarizeListView"],function(e){n.enforce_logged_in().then(function(){var e=new r.Query("Troupe").include("portrait").get(a);return e}).then(function(t,r){return n.troupeSummarizeCharacters=n.troupeSummarizeCharacters||new e({collection:new u}).setup(),n.troupeCharacters.register("#troupe/"+a+"/character/<%= character_id %>"),n.get_troupe_summarize_characters(t,n.troupeSummarizeCharacters.collection)}).then(function(){t.mobile.changePage("#troupe-summarize-characters-all",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)})},get_troupe_print_options:function(){var e=this;return e.troupePrintOptions=e.troupePrintOptions||new o.Model({font_size:100,exclude_extended:!1}),e.troupePrintOptions},troupe_select_to_print_characters:function(e,a){var i=this;t.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+e);var t=new r.Query("Troupe").include("portrait").get(e);return t}).then(function(t,r){return i.troupeSelectToPrintCharacters=i.troupeSelectToPrintCharacters||new j({collection:new u,el:"#troupe-select-to-print-characters-all > div[role='main']",print_options:i.get_troupe_print_options()}).setup(),i.troupeCharacters.register("#troupe/"+e+"/character/<%= character_id %>"),i.troupeSelectToPrintCharacters.submission_template=_.template("#troupe/"+e+"/characters/print/selected"),i.get_troupe_summarize_characters(t,i.troupeSelectToPrintCharacters.collection)}).then(function(){t.mobile.changePage("#troupe-select-to-print-characters-all",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)},troupe_print_characters:function(a,i){var n=this;t.mobile.loading("show"),"selected"==i?n.set_back_button("#troupe/"+a+"/characters/selecttoprint/all"):n.set_back_button("#troupe/"+a),e(["../views/CharactersPrintView"],function(e){n.enforce_logged_in().then(function(){var e=new r.Query("Troupe").include("portrait").get(a);return e}).then(function(t,r){return n.troupePrintCharacters=n.troupePrintCharacters||new e({collection:new u,el:"#troupe-print-characters-all > div[role='main']",print_options:n.get_troupe_print_options()}).setup(),n.troupeCharacters.register("#troupe/"+a+"/character/<%= character_id %>"),"selected"==i&&n.troupeSelectToPrintCharacters?void n.troupePrintCharacters.collection.reset(n.troupeSelectToPrintCharacters.get_filtered()):n.get_troupe_summarize_characters(t,n.troupePrintCharacters.collection)}).then(function(){t.mobile.changePage("#troupe-print-characters-all",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)})},troupe_portrait:function(e){var a=this;t.mobile.loading("show"),a.enforce_logged_in().then(function(){a.set_back_button("#troupe/"+e);var t=new r.Query("Troupe").include("portrait").get(e);return t}).then(function(e){a.troupePortraitView=a.troupePortraitView||new U({el:"#troupe-portrait"}),a.troupePortraitView.register(e),t.mobile.changePage("#troupe-portrait",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)},troupe_relationship_network:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#troupe/"+a),e(["../views/TroupeCharacterRelationshipsNetworkView"],function(e){i.enforce_logged_in().then(function(){var e=new r.Query("Troupe").include("portrait").get(a);return e}).then(function(e,t){return i.get_troupe_characters(e)}).then(function(t){return i.tcrnv=i.tcrnv||new e({el:"#troupe-character-relationships-network"}),i.tcrnv.register(t)}).always(function(){t.mobile.changePage("#troupe-character-relationships-network",{reverse:!1,changeHash:!1}),t.mobile.loading("hide")}).fail(S)})},troupeeditstaff:function(e,a){var i=this;t.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+e);var t=new r.Query("Troupe").include("portrait").get(e),n=new r.Query("User").get(a);return r.Promise.when(t,n)}).then(function(e,t){return i.troupeEditStaffView=i.troupeEditStaffView||new x({el:"#troupe-edit-staff"}),i.troupeEditStaffView.register(e,t)}).then(function(){t.mobile.changePage("#troupe-edit-staff",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(function(e){_.isArray(e)?_.each(e,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+e.message)})},troupeaddstaff:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#troupe/"+a),e(["../views/UsersView"],function(e){i.enforce_logged_in().then(function(){return new r.Query("Troupe").get(a)}).then(function(r){i.troupeAddStaffView=i.troupeAddStaffView||new e({el:"#troupe-add-staff"}),i.troupeAddStaffView.register("#troupe/"+r.id+"/staff/edit/<%= id %>"),t.mobile.changePage("#troupe-add-staff",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})},troupe:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#troupes"),e(["../views/TroupeView"],function(e){i.enforce_logged_in().then(function(){return new r.Query("Troupe").get(a)}).then(function(a){i.troupeView=i.troupeView||new e({el:"#troupe"});var n=r.User.current().get("storytellerinterface"),o=r.User.current().get("admininterface");i.troupeView.register(a,!(n||o)),t.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})},troupes:function(){var r=this;t.mobile.loading("show"),r.set_back_button("#"),e(["../views/TroupesListView"],function(e){r.enforce_logged_in().then(function(){return r.troupesListView=r.troupesListView||new e({el:"#troupes-list"}).render(),r.troupesListView.register()}).then(function(){t.mobile.changePage("#troupes-list",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})},troupenew:function(){var r=this;t.mobile.loading("show"),r.set_back_button("#troupes"),e(["../views/TroupeNewView"],function(e){r.enforce_logged_in().then(function(){r.troupeNewView=r.troupeNewView||new e({el:"#troupe-new"}).render(),t.mobile.changePage("#troupe-new",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})},administration:function(){var e=this;e.enforce_logged_in().then(function(){e.set_back_button("#"),t.mobile.changePage("#administration",{reverse:!1,changeHash:!1})})},administration_characters_all:function(){var e=this;t.mobile.loading("show"),e.enforce_logged_in().then(function(){return e.set_back_button("#administration"),e.get_administrator_characters()}).then(function(){e.characters.register("#administration/character/<%= character_id %>"),t.mobile.changePage("#characters-all",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)},administration_characters_summarize:function(){var r=this;t.mobile.loading("show"),r.set_back_button("#administration"),e(["../views/CharactersSummarizeListView"],function(e){r.enforce_logged_in().then(function(){return r.get_administrator_summarize_characters()}).then(function(){r.administrationSummarizeCharacters=r.administrationSummarizeCharacters||new e({collection:r.characters.collection}).setup(),r.troupeCharacters.register("#administration/character/<%= character_id %>"),t.mobile.changePage("#troupe-summarize-characters-all",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")}).fail(S)})},referendums:function(){var r=this;t.mobile.loading("show"),r.set_back_button("#"),e(["../views/ReferendumsListView"],function(e){r.enforce_logged_in().then(function(){return r.referendumsListView=r.referendumsListView||new e({el:"#referendums-list"}).render(),r.referendumsListView.register()}).then(function(){t.mobile.changePage("#referendums-list",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})},referendum:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#referendums"),e(["../models/Referendum","../views/ReferendumView"],function(e,n){i.enforce_logged_in().then(function(){var t=new r.Query(e);t.include("portrait");var i=new r.Query("ReferendumBallot").equalTo("owner",new e({id:a})).equalTo("caster",r.User.current());return r.Promise.when(t.get(a),i.first(),r.Cloud.run("get_my_patronage_status"))}).then(function(e,t,r){return i.referendumView=i.referendumView||new n({el:"#referendum"}),i.referendumView.setup({referendum:e,patronagestatus:r,ballot:t})}).then(function(){t.mobile.changePage("#referendum",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})},administration_referendums:function(){var r=this;t.mobile.loading("show"),r.set_back_button("#administration"),e(["../views/ReferendumsListView"],function(e){r.enforce_logged_in().then(function(){return r.referendumsListView=r.referendumsListView||new e({el:"#referendums-list"}).render(),r.referendumsListView.register("#administration/referendum/<%= referendum_id %>")}).then(function(){t.mobile.changePage("#referendums-list",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})},administration_referendum:function(a){var i=this;t.mobile.loading("show"),i.set_back_button("#administration/referendums"),e(["../models/Referendum","../collections/ReferendumBallots","../views/ReferendumView"],function(e,n,o){i.enforce_logged_in().then(function(){var t=new r.Query(e);t.include("portrait");var i=new n;return r.Promise.when(t.get(a),i.fetch(new e({id:a})),I.get_users(),r.Cloud.run("get_my_patronage_status"))}).then(function(e,t,r,a){return i.referendumView=i.referendumView||new o({el:"#referendum"}),i.referendumView.setup({referendum:e,ballots:t,users:r,patronagestatus:a})}).then(function(){t.mobile.changePage("#referendum",{reverse:!1,changeHash:!1})}).always(function(){t.mobile.loading("hide")})})}});return O});