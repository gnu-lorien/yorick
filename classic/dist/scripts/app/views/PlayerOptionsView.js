define(["backbone","marionette","text!../templates/player_options.html","../helpers/PromiseFailReport","parse","../helpers/RoleWreqr","../helpers/TroupeWreqr","../collections/Troupes","text!../templates/troupe-list-entry.html"],function(e,t,r,n,a,i,s,o,l){var u=t.ItemView.extend({tagName:"li",className:"ul-li-has-thumb",template:_.template(l),templateHelpers:function(){return{e:this.model}},onRender:function(){this.$el.enhanceWithin()}}),p=t.CompositeView.extend({template:function(e){return _.template('<h3>Troupe View All Characters</h3><% if (loading) { %> <p>Loading Your Troupes...</p><% } %><ul data-role="listview"></ul>')(e)},initialize:function(e){var t=this;t.options=e,this.listenTo(t.model,"change",t.render)},childView:u,childViewContainer:"ul",onRender:function(){this.$el.enhanceWithin()},collectionEvents:{reset:function(){var e=this;_.defer(function(){e.$el.enhanceWithin()})}}}),c=t.LayoutView.extend({template:_.template(r),regions:{troupcharactersquickaccess:"#troupe-characters-quick-access"},initialize:function(e){var t=this;t.options=e||{},t.roles=i.channel.reqres.request("all"),t.listenTo(t.roles,"add reset remove change",t.update_troupes),t.troupes=new o;var r=s.channel.reqres.request("all");t.listenTo(r,"add reset remove change",t.update_troupes),_.bindAll(this,"setup","update_troupes")},update_troupes:function(){var e=this;return e._updateTroupeWrapper=e._updateTroupeWrapper||a.Promise.as(),e._updateTroupeWrapper=e._updateTroupeWrapper.always(function(){var t=[];_.each(e.roles.models,function(e){var r=e.attributes.attributes.name;r=r.split("_"),r=r[1];var n=s.channel.reqres.request("get",r);n&&t.push(n)}),e.troupes.reset(t)}),e._updateTroupeWrapper},setup:function(){var t=this,r=t.options||{};t.render();var o=a.User.current().get("storytellerinterface"),l=a.User.current().get("admininterface");if(!l&&!o)return t;var u=new e.Model;u.set("loading",!0),t.showChildView("troupcharactersquickaccess",new p({model:u,collection:t.troupes}),r);var c=[];return c.push(s.get_troupes()),c.push(i.get_current_roles()),a.Promise.when(c).fail(n).always(function(){u.set("loading",!1)}),t}});return c});