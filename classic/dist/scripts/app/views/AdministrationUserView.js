define(["jquery","backbone","parse","backform","../forms/UserForm","marionette","../views/PatronagesView","../collections/Patronages"],function(e,t,n,r,i,a,o,s){var l=a.ItemView.extend({tagName:"form",template:_.template(""),initialize:function(){var a=this;a.errorModel=new t.Model,this.form=new i({errorModel:a.errorModel,model:new t.Model,events:{submit:function(t){var r=this;t.preventDefault(),r.undelegateEvents(),e.mobile.loading("show");var i=r.model;new n.Query(n.Role).equalTo("name","Administrator").first().then(function(e){return i.get("admininterface")?e.getUsers().add(i):e.getUsers().remove(i),e.save()}).then(function(){i.get("admininterface")?r.fields.get("submit").set({status:"success",message:"Made them an admin!"}):r.fields.get("submit").set({status:"success",message:"Removed their admin privileges!"})}).fail(function(e){r.fields.get("submit").set({status:"error",message:_.escape(e.message)})}).always(function(){r.$el.enhanceWithin(),e.mobile.loading("hide"),r.delegateEvents()})}}}),a.form.fields.each(function(e){e.set("disabled",!0)}),a.form.fields.add(new r.Field({name:"admininterface",label:"Administrator",control:"checkbox"})),a.form.fields.add(new r.Field({name:"submit",label:"Update",control:"button",id:"submit"}))},register:function(e){var t=this;if(t.user=e,t.form.model.id!=e.id){t.form.fields.get("submit").set({status:"",message:""});var r=new n.Query(n.Role).equalTo("users",e).equalTo("name","Administrator"),i=new n.Query(n.Role).equalTo("users",e).equalTo("name","SiteAdministrator"),a=n.Query.or(r,i);return a.count().then(function(n){e.set("admininterface",!!n);var r=t.form.errorModel;return t.form.model=e,t.form.model.errorModel=r,t.render()})}},onRender:function(){return this.form.setElement(this.$el),this.form.render(),this.$el.enhanceWithin(),this}}),d=a.ItemView.extend({tagName:"div",template:function(e){return _.template("<button>Reset Password</button><p class='message'></p>")(e)},events:{click:function(t){t.preventDefault();var r=this,i=r.model.get("email"),a=r.$("button"),o=r.$(".message");e.mobile.loading("show"),r.undelegateEvents(),a.attr("disabled",!0),n.User.requestPasswordReset(i).then(function(){o.text("Password Reset Email Sent")},function(e){o.text(_.escape(e.message))}).always(function(){r.$el.enhanceWithin(),r.$("button").removeAttr("disabled"),e.mobile.loading("hide"),r.delegateEvents()})}}}),m=a.ItemView.extend({tagName:"div",template:function(e){return _.template("<a href='#administration/patronages/new/<%= userid %>'>Add New Patronage</a>")(e)},modelEvents:{change:"render"}}),u=a.ItemView.extend({template:function(e){return _.template("The one: <%= attributes.name %>")(e)}}),c=a.CollectionView.extend({tagName:"div",childView:u}),f=a.LayoutView.extend({el:"#administration-user-view",regions:{profile:"#abs-form",password:"#reset-password-view",patronage:"#patronage-list-region",patronage_new:"#patronage-new-for-user-button",roles:"#administration-user-roles-available"},initialize:function(e){var n=this;n.patronages=new s,n.showChildView("profile",new l,e),n.showChildView("password",new d,e),n.showChildView("patronage",new o({el:"#patronage-list",collection:n.patronages,back_url_base:"#administration/patronage/"})),n.showChildView("patronage_new",new m({model:new t.Model({userid:""})})),n.roles=new t.Collection,n.showChildView("roles",new c({collection:n.roles}),e)},register:function(e){var t=this;t.profile.currentView.register.apply(t.profile.currentView,arguments),t.password.currentView.model=e,t.patronage.currentView.render(),t.patronage_new.currentView.model.set("userid",e.id);var r=new n.Query(n.Role);r.each(function(n){var r=n.getUsers(),i=r.query();return i.equalTo("objectId",e.id),i.each(function(e){t.roles.add(n)}).fail(function(e){console.log("Failed in promise for "+n.get("name"))})})}});return f});