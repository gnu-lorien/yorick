define(["jquery","backbone","parse"],function(e,t,r){var i=t.View.extend({initialize:function(e){var t=this;_.bindAll(t,"update")},register:function(e){var t=this;if(e!==t.troupe){t.troupe&&t.stopListening(t.troupe);var i=e.get("portrait")?e.get("portrait").fetch():r.Promise.as([]);return i.then(function(){return t.troupe=e,t.listenTo(t.troupe,"change:portrait",t.render),r.Promise.as(t.render())})}return r.Promise.as(t)},events:{"submit form.portrait-form":"update","click .update":"update"},update:function(t){var i=this,o=i.$("#troupe-input-portrait")[0].files[0],n=o.name.split(".").pop();o.size>1e6&&i.$(".error").html(_.escape("Picture too large. Limit is 1MB")).show();var s=new r.File("portrait"+n,o);return e.mobile.loading("show"),i.undelegateEvents(),s.save().done(function(e){var t;t=i.troupe.get("portrait")?i.troupe.get("portrait"):new r.Object("TroupePortrait");var o=new r.ACL;return o.setPublicReadAccess(!0),o.setPublicWriteAccess(!1),o.setRoleReadAccess("LST",!0),o.setRoleWriteAccess("LST",!0),t.setACL(o),t.set("original",e),t.save()}).done(function(e){return i.troupe.set("portrait",e),i.troupe.save()}).done(function(){i.$(".error").hide()}).fail(function(e){i.$(".error").html(_.escape(e.message)).show(),console.log(e.message)}).always(function(){i.delegateEvents(),e.mobile.loading("hide")}),!1},render:function(){return this.template=_.template(e("script#troupePortraitView").html())({troupe:this.troupe}),this.$el.find("div[role='main']").html(this.template),this.$el.enhanceWithin(),this}});return i});