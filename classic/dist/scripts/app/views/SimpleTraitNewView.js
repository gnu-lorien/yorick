define(["jquery","backbone","parse","backform","marionette","../models/SimpleTrait","../collections/BNSMETV1_ClanRules","marionette","text!../templates/simpletrait-new-base.html","text!../templates/simpletrait-new-list.html","../helpers/Progress","../helpers/PromiseFailReport","../helpers/DescriptionFetcher"],function(e,t,i,a,n,r,l,n,c,o,s,u,f){var h=n.ItemView.extend({initialize:function(e){this.gift_filter_options=e.gift_filter_options,this.listenTo(this.gift_filter_options,"change",this.render),_.bindAll(this,"register","update_collection_query_and_fetch","templateHelpers")},template:_.template(o),templateHelpers:function(){var e,t=this;t.requireSpecializations=_.chain(t.collection.models).select(function(e){return"requires_specialization"==e.get("requirement")}).pluck("attributes").pluck("name").value();var i=_(t.character.get(t.category)).pluck("attributes").pluck("name").without(t.requireSpecializations).value();if("in clan disciplines"==t.filterRule){var a=_.without(t.character.get_in_clan_disciplines(),void 0);e=_.chain(t.collection.models),0!=a.length&&(e=e.select(function(e){return!_.contains(i,e.get("name"))&&!!_.contains(a,e.get("name"))})),e=e.value()}else e="affinity"==t.filterRule?t.get_affinity_items():_.chain(t.collection.models).select(function(e){return!_.contains(i,e.get("name"))}).value();if("wta_gifts"==t.category){if("mine"==t.gift_filter_options.attributes.affinities&&(e=t.get_affinity_items()),t.gift_filter_options.attributes.ladder){var n=[1],r=_.countBy(t.character.get("wta_gifts"),function(e){return e.attributes.value});_.each(_.range(2,6),function(e){var t=r[e]||0,i=r[e-1]||0,a=i-t;a<=0||!_.isFinite(a)?a=0:n.push(e)}),e=_.select(e,function(e){return _.contains(n,_.parseInt(e.attributes.value))})}"alpha"==t.gift_filter_options.attributes.sort?e=_.sortByAll(e,["attributes.name"]):"level"==t.gift_filter_options.attributes.sort&&(e=_.sortByAll(e,["attributes.value","attributes.name"])),"desc"==t.gift_filter_options.attributes.direction&&(e=_(e).reverse().value())}return{collection:e,character:t.character,category:t.category,free_value:t.free_value}},get_affinity_items:function(){var e=this,t=e.character.get_affinities(),i=_.chain(e.collection.models);return 0!=t.length&&(i=i.select(function(e){return _.some(_.map(_.range(1,4),function(i){return!!_.contains(t,e.get("affinity_"+i))}))})),i.value()},switch_character_category_listening:function(){var e=this;e.character&&(e.stopListening(e.character),e.listenTo(e.character,"change:"+e.category,e.render))},register:function(e,t,a,n,r,l){var c=this,o=!1,n=n||"#simpletrait/spacer/<%= self.category %>/<%= self.character.id %>/<%= b.get('name') %>/<%= b.get('value') %>/<%= b.get('free_value') || 0 %>/new",l=l||"#simpletrait/specialize/<%= self.category %>/<%= self.character.id %>/<%= b.get('name') %>/<%= b.get('value') %>/<%= b.get('free_value') || 0 %>/new";n!=_&&n!=c.redirect&&(c.redirect=_.template(n),o=!0),l!=_&&l!=c.specializationRedirect&&(c.specializationRedirect=_.template(l)),c.filterRule!==r&&(c.filterRule=r,o=!0),a!==c.free_value&&a!=_&&(c.free_value=a,o=!0),e!==c.character&&(c.character&&c.stopListening(c.character),c.character=e,c.listenTo(c.character,"change:"+t,c.render),o=!0);var s=i.Promise.as();return t!=c.category&&(c.category=t,c.switch_character_category_listening(),c.collection&&c.stopListening(c.collection),c.collection=f(t),c.listenTo(c.collection,"add",c.render),c.listenTo(c.collection,"reset",c.render),s=c.update_collection_query_and_fetch(),o=!0),o?s.then(function(){return c.render()}):s.then(function(){return c})},update_collection_query_and_fetch:function(){var e=this;return s("Fetching "+e.category),e.collection.fetch_avoiding_wait().done(function(){s()}).fail(u)},onRender:function(){this.$el=this.$el.children(),this.$el.unwrap(),this.setElement(this.$el),this.$el.enhanceWithin()},events:{"click .simpletrait":"clicked"},clicked:function(t){var i=this;e.mobile.loading("show");var a=e(t.target).attr("backendId"),n=i.collection.get(a),l=_.parseInt(n.get("value")),c=1;l&&(c=l);var o=new r({name:e(t.target).attr("name"),value:c,category:i.category,free_value:i.free_value});return _.contains(i.requireSpecializations,o.get("name"))?window.location.hash=i.specializationRedirect({self:i,b:o}):window.location.hash=i.redirect({self:i,b:o}),!1}}),g=a.Form.extend({fields:[{name:"affinities",label:"Show by Affinity",control:"select",options:[{label:"Mine",value:"mine"},{label:"Any",value:"any"}]},{name:"ladder",label:"Show only available on the gift level ladder",control:"checkbox"},{name:"sort",label:"Sort By",control:"select",options:[{label:"Alphabetical",value:"alpha"},{label:"Level",value:"level"}]},{name:"direction",label:"Direction",control:"select",options:[{label:"Ascending",value:"asc"},{label:"Descending",value:"desc"}]}]}),d=n.LayoutView.extend({template:_.template(c),regions:{filter_rules:"#category-filter-rules",list:"#category-list"},model:new t.Model,initialize:function(){var e=this;e.gift_filter_options=new t.Model({affinities:"mine",ladder:!0,sort:"level",direction:"asc"})},register:function(e,t,i,a,n,r){var l=this;l.model.set("free_value",i),l.render(),"wta_gifts"==t&&l.showChildView("filter_rules",new g({model:l.gift_filter_options})),l.view=new h({gift_filter_options:l.gift_filter_options});var c=l.view.register(e,t,i,a,n,r);return l.showChildView("list",l.view),l.$el.enhanceWithin(),c}});return d});