define(["jquery","backbone","parse","vis"],function(e,t,n,r){var o=t.View.extend({initialize:function(){_.bindAll(this,"select_node","make_relationship"),this.network=null,this.selected_nodes=[]},register:function(e){var t=this;t.characters=e;var r=[],o=[],s=[];return t.characters.each(function(e,t){var n=e.get_thumbnail(32).then(function(t){r.push({id:e.id,shape:"image",image:t,label:e.get("name")})});s.push(n)}),n.Promise.when(s).then(function(){var e=[];return t.characters.each(function(t,r){var s=new n.Query("CharacterRelationship");s.equalTo("from",t.id),e.push(s.each(function(e){o.push({from:e.get("from"),to:e.get("to"),color:e.get("color")})}))}),n.Promise.when(e)}).then(function(){return t.data={nodes:r,edges:o},n.Promise.as(t.render())},function(e){console.log(e)})},events:{"click .update":"update","click .make-relationship":"make_relationship"},select_node:function(e){var t=this;t.selected_nodes=e.nodes,t.selected_nodes.length>=2?t.$(".make-relationship").removeAttr("disabled"):t.$(".make-relationship").attr("disabled","disabled")},make_relationship:function(){var e=this,t=[];if(2==e.selected_nodes.length){var r=new n.Object("CharacterRelationship");r.set("from",e.selected_nodes[0]),r.set("to",e.selected_nodes[1]),r.set("color","red"),t.push(r.save())}else{for(var o=[];0!=e.selected_nodes.length;){var s=e.selected_nodes.pop();_.each(e.selected_nodes,function(e){var t=new n.Object("CharacterRelationship");t.set("from",s),t.set("to",e),t.set("color","red"),o.push(t)})}t.push(n.Object.saveAll(o))}n.Promise.when(t).then(function(){window.location.reload()})},build_network:function(){var e=this,t=e.$("#relationships-network"),n=t[0],o={layout:{randomSeed:24993},nodes:{borderWidth:4,size:30,color:{border:"#406897",background:"#6AAFFF"},font:{color:"#eeeeee"},shapeProperties:{useBorderWithImage:!0}},edges:{color:"lightgray"},interaction:{multiselect:!0}};return e.network&&e.network.destroy(),e.network=new r.Network(n,e.data,o),e.network.on("selectNode",e.select_node),e.network},render:function(){var t=this;this.template=_.template(e("#troupeCharacterRelationshipsNetworkView").html())({user:n.User.current(),characters:t.characters.models}),this.$el.find("div[role='main']").html(this.template),this.$el.enhanceWithin(),t.build_network()}});return o});