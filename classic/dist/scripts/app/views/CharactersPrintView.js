define(["underscore","jquery","backbone","marionette","parse","moment","text!../templates/character-print-view.html","text!../templates/character-approval-approvals.html","../collections/Approvals","../models/Approval","text!../templates/character-approval-selected-view.html","../helpers/VampirePrintHelper","text!../templates/character-approval-edit.html","../views/CharacterPrintView","text!../templates/character-approval-changes.html","../helpers/PromiseFailReport"],function(e,t,i,a,r,n,s,o,d,p,c,l,h,g,v,m){var u=a.ItemView.extend({template:e.template(h),templateHelpers:function(){var e=this,t=e.picked.get("left")>=e.model.recorded_changes.length;if(0!=e.approvals.length){var i=e.approvals.last().get("change").id,a=e.model.recorded_changes.last().id;i==a&&(t=!0)}return{character:this.model,logs:this.model.recorded_changes.models,indexForPickedChange:e.picked.get("right"),format_approval:e.format_approval,left_rc_index:e.picked.get("left"),approval_index:e.picked.get("approval"),approvals:e.approvals.models,no_changes_remaining:t}},events:{"click .approve-change":"approve_change"},initialize:function(t){this.picked=t.picked,this.approvals=t.approvals,this.no_changes_remaining=!1,this.listenTo(this.picked,"change:right",e.debounce(this.render,100,{trailing:!0})),e.bindAll(this,"templateHelpers","format_approval","approve_change")},format_approval:function(t,i){var a=t.get(i);return e.isUndefined(a)?e.result(t,i):e.has(a,"id")?a.id:a},approve_change:function(e){var t=this;e.preventDefault();var i=t.model.recorded_changes.at(t.picked.get("right")),a=new p({approved:!0,change:i,approver:r.User.current(),owner:t.model});a.save().then(function(e){t.approvals.add(e),t.picked.set({approval:t.approvals.length,left:t.picked.get("right"),right:t.model.recorded_changes.models.length-1}),t.render()})},onRender:function(){this.$el.enhanceWithin()}}),f=a.ItemView.extend({template:e.template(v),templateHelpers:function(){var e=this;return{character:this.model,logs:this.model.recorded_changes.models,right_rc_index:e.picked.get("right"),left_rc_index:e.picked.get("left")}},initialize:function(t){this.picked=t.picked,this.watchPicks(),this.listenTo(this.model,"saved",this.update_then_render),e.bindAll(this,"templateHelpers","update_then_render")},events:{"change #slider":"update_right","change #sliderbaserange":"update_left"},watchPicks:function(){this.listenTo(this.picked,"change",this.render)},unwatchPicks:function(){this.stopListening(this.picked)},update_right:function(t){this.unwatchPicks();var i=e.parseInt(this.$(t.target).val());this.picked.set("right",i);this.$("#history-changes-"+i).val();this.watchPicks()},update_left:function(t){this.unwatchPicks();var i=e.parseInt(this.$(t.target).val());this.picked.set("left",i);this.$("#history-changes-"+i).val();this.watchPicks()},update_then_render:function(){var e=this;e.model.update_recorded_changes().then(function(){e.render()})},onRender:function(){this.$el.enhanceWithin()}}),_=a.ItemView.extend({template:e.template(o),templateHelpers:function(){var e=this;return{character:this.model,logs:this.model.recorded_changes.models,approvals:e.approvals.models,approval_index:e.picked.get("approval")}},initialize:function(t){this.picked=t.picked,this.approvals=t.approvals,this.update_picks_for_approval(this.picked.get("approval")),this.watchPicks(),this.listenTo(this.model,"saved",this.render),e.bindAll(this,"templateHelpers","approval_changed","update_picks_for_approval")},events:{"change #approval-slider":"update_index"},watchPicks:function(){this.listenTo(this.picked,"change:approval",this.approval_changed)},unwatchPicks:function(){this.stopListening(this.picked)},update_picks_for_approval:function(t){var i=this,a=i.approvals.models[t],r=0,n=i.model.recorded_changes.length-1;if(a&&e.findLast(i.model.recorded_changes.models,function(e,t){return e.id==a.get("change").id&&(n=t,!0)}),t>0){var s=t-1,o=i.approvals.models[s];e.findLast(i.model.recorded_changes.models,function(e,t){return e.id==o.get("change").id&&(r=t+1,!0)})}i.picked.set({approval:t,left:r,right:n})},approval_changed:function(){this.unwatchPicks(),this.update_picks_for_approval(this.picked.get("approval")),this.render(),this.watchPicks()},update_index:function(t){var i=this;this.unwatchPicks();var a=e.parseInt(this.$(t.target).val());i.update_picks_for_approval(a),this.watchPicks()},onRender:function(){this.$el.enhanceWithin()}}),k=a.ItemView.extend({template:e.template(c),templateHelpers:function(){var e=this;return{character:this.model,logs:this.model.recorded_changes.models,indexForPickedChange:e.picked.get("right"),format_entry:e.format_entry,left_rc_index:e.picked.get("left")}},initialize:function(t){this.picked=t.picked,this.approvals=t.approvals,this.no_changes_remaining=!1,this.listenTo(this.picked,"change:right change:left",e.debounce(this.render,100,{trailing:!0})),e.bindAll(this,"templateHelpers","format_entry")},format_entry:function(t,i){if(e.isUndefined(t))return console.log("Undefined log"),"Undefined log";if(t.get(i))return t.get(i);var a=t[i];return e.isDate(a)?n(a).format("lll"):a},onRender:function(){this.$el.enhanceWithin()}}),w=(a.LayoutView.extend({tagName:"div",regions:{changes:"#approval-changes",approvals:"#approval-approvals",edit:"#approval-edit",viewing:"#approval-viewing",sheet:"#approval-sheet"},initialize:function(){e.bindAll(this,"update_override_character_and_transform")},update_override_character_and_transform:function(){var t,i,a,r=this;if(r.picked.has("right")){var n=r.model.recorded_changes.at(r.picked.get("right"));n=n.id||n.cid||null;var s=e.chain(r.model.recorded_changes.models).takeRightWhile(function(e){return e.id!=n}).reverse().value();t=r.model.get_transformed(s)}if(r.picked.has("left")&&r.picked.has("right")){var o=e.chain(r.model.recorded_changes.models).takeRightWhile(function(e,t){return t!=r.picked.get("left")-1}).reverse().value();a=r.model.get_transformed(o),i=e.takeRight(a.transform_description,r.picked.get("right")+1-r.picked.get("left"));var d=e(i).select({type:"removed"}).value();e.each(d,function(i){i.fake.is_deleted=!0,t.set(i.category,e.union(t.get(i.category),[i.fake]))}),r.model.transform_description=i,t&&(t.transform_description=i)}r.override.set({character:t,description:i,described:a})},register:function(t){var a=this,n=r.Promise.as([]);return t!=a.model&&(a.model=t,a.picked&&a.stopListening(a.picked),a.picked=new i.Model({left:0,right:0,approval:0}),a.override&&a.stopListening(a.override),a.override=new i.Model({character:null,description:null}),n=a.model.get_recorded_changes().then(function(){return a.picked.set("left",0),a.picked.set("right",a.model.recorded_changes.models.length-1),a.model.get_approvals()}).then(function(t){a.approvals=t,a.picked.set("approval",a.approvals.length),a.listenTo(a.picked,"change:right change:left",e.debounce(a.update_override_character_and_transform,100,{trailing:!0})),a.showChildView("changes",new f({model:a.model,picked:a.picked})),a.showChildView("approvals",new _({model:a.model,picked:a.picked,approvals:a.approvals})),a.showChildView("edit",new u({model:a.model,picked:a.picked,approvals:a.approvals})),a.showChildView("viewing",new k({model:a.model,picked:a.picked}));var i=new g;i=i.setup({character:a.model,override:a.override}),a.showChildView("sheet",i)})),n.then(function(){r.Promise.as(a)})},onRender:function(){this.$el.enhanceWithin()}}),a.CollectionView.extend({childView:g,setup:function(){return this.render()},buildChildView:function(e,t,i){var a=new g({no_print_settings_form:!0});return a.setup({character:e,print_options:this.options.print_options})}}));return w});