define(["underscore","jquery","backbone","text!../templates/character-summarize-list-item.html","marionette","../models/Vampire","backform","text!../templates/character-summarize-list-item-csv.html","text!../templates/character-summarize-list-item-csv-header-grouped.html","../helpers/PromiseFailReport","papaparse"],function(e,t,o,n,r,a,i,s,l,c,u){var d=i.Form.extend({fields:[{control:"button",label:"Update Changes to Server"},{name:"descriptiondata",label:"Descriptions",control:"textarea",maxlength:1e5}],events:{submit:function(t){var o=this;t.preventDefault();var n=u.parse(o.model.get("descriptiondata"),{header:!0});if(console.log(n),0!=n.errors.length)return console.log(JSON.stringify(n.errors)),void e.each(n.errors,function(e){e.row&&console.log("Row "+e.row+" has bad data "+e.message)});var r=e.map(n.data,function(t,o){var n,r=new Parse.Query("Description").equalTo("category",t.category).equalTo("name",t.name);return r.first().then(function(o){o?console.log("Found existing object for "+t.category+" "+t.name):(o=new Parse.Object("Description",{name:t.name,category:t.category}),console.log("Didn't find existing object for "+t.category+" "+t.name));var r=new Parse.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!1),r.setRoleReadAccess("Administrator",!0),r.setRoleWriteAccess("Administrator",!0),o.setACL(r);var a=e.omit(t,function(t){return!!e.includes(["name","category"],t)||""==t});return e.each(a,function(t,n){"order"==n?o.set(n,e.parseInt(t)):o.set(n,t)}),console.log(o.attributes),n=" "+o.id+" "+o.attributes.name,o.save()}).fail(function(e){console.log(e),console.log("Error on saving disguy?"+n)})});Parse.Promise.when(r).then(function(){console.log(JSON.stringify(arguments)),console.log("Saved all of that")}).then(function(){console.log("Saved all of that")}).fail(c)}}}),m=i.Form.extend({fields:[{name:"category",label:"Category",control:"select",options:[{label:"None",value:"None"}]}]}),f=r.LayoutView.extend({el:"#administration-descriptions > div[data-role='main']",regions:{sections:"#descriptions-sections",list:"#administration-descriptions-list"},childEvents:{filterwith:"filterwith",submit:"submit"},filterwith:function(t){var o,n=this;o="All"==t.get("category")?new Parse.Query("Description"):new Parse.Query("Description").equalTo("category",t.get("category"));var r=[];return o.each(function(t){r.push(e.omit(t.attributes,"ACL"))}).then(function(){r=e(r).sortByAll(["category","order","name"]).value();var t=e(r).map(function(t){return e.keys(t)}).tap(function(e){console.log(e)}).flatten().uniq().value();n.data.set("descriptiondata",u.unparse({fields:t,data:r}))}).fail(c)},getColumnNames:function(t){var o=this;return e(o.collection.models).map("attributes."+t).flatten().map("attributes.name").without(void 0).sortBy().uniq(!0).value()},setup:function(){var e=this,t=e.options||{};return e.filterOptions=new o.Model({playable:!0,category:"attributes",antecedence:"PC",resulttype:"onlycat",format:"pretty"}),e.data=new o.Model({descriptiondata:"Nothing here yet"}),e.listenTo(e.filterOptions,"change",e.filterwith),e.showChildView("sections",new m({model:e.filterOptions}),t),e.showChildView("list",new d({model:e.data}),t),this.$el.enhanceWithin(),e},update_categories:function(){var t=this,o=new Parse.Query("Description");o.select("category");var n={};return o.each(function(e){n[e.get("category")]=1}).then(function(){console.log(n);var o=t.sections.currentView,r=o.fields.models[0],a=e.map(n,function(e,t){return{label:t,value:t}});return a=e.sortBy(a,"label"),a.push({label:"All",value:"All"}),r.set("options",a),Parse.Promise.as(o.render())})}});return f});