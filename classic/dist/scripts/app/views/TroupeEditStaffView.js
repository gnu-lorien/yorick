define(["jquery","backbone","parse","backform","../helpers/PromiseFailReport"],function(e,r,t,o,n){var i=r.View.extend({initialize:function(){_.bindAll(this,"render","submit")},register:function(e,r){var n=this;n.troupe=e,n.user=r;var i={};return t.Promise.when(n.troupe.get_roles()).then(function(e){i=e;var r=_.map(n.troupe.title_options,function(e){var r=i[e].getUsers(),t=r.query();return t.equalTo("objectId",n.user.id),t.count().then(function(r){i[e]=r,console.log("Setting up role "+e+" count with "+r)})});return t.Promise.when(r)}).then(function(){var e=_.findKey(i,function(e,r,t){return console.log("Got "+e+" for "+r),!!(_.isFinite(e)&&e>0)});return console.log("I found this user with a role of "+e),t.Promise.as(e)}).then(function(e){n.user.set("role",e||"None"),n.form=new o.Form({el:"#troupe-edit-staff-form",model:n.user,fields:[{name:"username",label:"Username",control:"uneditable-input"},{name:"realname",label:"Name",control:"uneditable-input"},{name:"role",label:"Role",control:"select",options:[{label:"Lead Storyteller",value:"LST"},{label:"Assistant Storyteller",value:"AST"},{label:"Narrator",value:"Narrator"},{label:"Not on Staff",value:"None"}]},{control:"spacer"},{control:"button",label:"Save"}]}),n.render()}).fail(function(e){_.isArray(e)?_.each(e,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+e.message)})},events:{submit:"submit"},submit:function(e){var r=this;e.preventDefault();var o=r.user.get("role"),i=_.slice(r.troupe.title_options),l=[];return"None"!=o&&(l.push(o),i=_.xor(i,l)),t.Cloud.run("change_troupe_staff",{troupe_id:r.troupe.id,user_to_change_id:r.user.id,roles_to_add:l,roles_to_remove:i}).always(function(){window.location.hash="#troupe/"+r.troupe.id}).fail(n)},render:function(){var e=this;return e.form.render(),this.$el.enhanceWithin(),this}});return i});