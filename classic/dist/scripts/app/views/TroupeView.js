define(["jquery","backbone","backform","../models/Troupe","../forms/TroupeForm","text!../templates/troupe-staff-list.html","parse","text!../templates/troupe-portrait-display.html","text!../templates/troupe.html"],function(e,t,r,a,o,i,n,l,s){var c=t.View.extend({initialize:function(){_.bindAll(this,"render","addstaff")},register:function(t,a){var i=this,l=!1;return t===i.troupe&&a==i.readonly||(i.troupe=t,i.readonly=a,i.form=new o({el:"#troupe-data",model:i.troupe,events:{submit:function(t){t.preventDefault(),e.mobile.loading("show"),console.log(n.User.current().get("username")),this.model.save().then(function(e){console.log("Saved the troupe")}).fail(function(e){console.log("Failed to save troupe "+e.message),window.location.hash="#administration"}).always(function(){e.mobile.loading("hide")})}}}),a||i.form.fields.add(new r.Field({control:"button",label:"Update"})),l=!0),l?i.render():i},events:{"click .troupe-add-staff":"addstaff","click .troupe-view-characters":"viewcharacters","click .troupe-view-character-relationships":"viewrelationships","click .troupe-view-summarize-characters":"viewsummarizecharacters","click .troupe-view-print-characters":"viewprintcharacters"},addstaff:function(e){var t=this;e.preventDefault(),window.location.hash="#troupe/"+t.troupe.id+"/staff/add"},viewcharacters:function(e){var t=this;e.preventDefault(),window.location.hash="#troupe/"+t.troupe.id+"/characters/all"},viewsummarizecharacters:function(e){var t=this;e.preventDefault(),window.location.hash="#troupe/"+t.troupe.id+"/characters/summarize/all"},viewprintcharacters:function(e){var t=this;e.preventDefault(),window.location.hash="#troupe/"+t.troupe.id+"/characters/selecttoprint/all"},viewrelationships:function(e){var t=this;e.preventDefault(),window.location.hash="#troupe/"+t.troupe.id+"/characters/relationships/network"},render:function(){var t=this;t.template=_.template(s)({readonly:t.readonly}),t.$el.find("div[role='main']").html(t.template),t.form.setElement(e("#troupe-data")),t.form.render(),t.troupe.get_staff().then(function(e){t.staff_template=_.template(i)({collection:e}),t.$el.find("#troupe-staff").html(t.staff_template),t.$el.enhanceWithin()});var r=t.troupe.get("portrait")?t.troupe.get("portrait").fetch():n.Promise.as([]);return r.then(function(){var e=_.template(l)({troupe:t.troupe});t.$el.find("#troupe-portrait-display").html(e),t.$el.enhanceWithin()}),this}});return c});