define(["jquery","backbone","parse"],function(e,t,r){var a=t.View.extend({initialize:function(e){var t=this;_.bindAll(t,"update")},register:function(e){var t=this;if(e!==t.character){t.character&&t.stopListening(t.character);var a=e.get("portrait")?e.get("portrait").fetch():r.Promise.as([]);return a.then(function(){return t.character=e,t.listenTo(t.character,"change:portrait",t.render),r.Promise.as(t.render())})}return r.Promise.as(t)},events:{"submit form.portrait-form":"update","click .update":"update"},update:function(t){var a=this,i=a.$("#input-portrait")[0].files[0],n=i.name.split(".").pop();i.size>1e6&&a.$(".error").html(_.escape("Picture too large. Limit is 1MB")).show();var c=new r.File("portrait"+n,i);return e.mobile.loading("show"),a.undelegateEvents(),c.save().done(function(e){var t;if(a.character.get("portrait")){t=a.character.get("portrait");var i=a.character.get_me_acl();i.setPublicReadAccess(!0),t.setACL(i)}else{t=new r.Object("CharacterPortrait");var i=a.character.get_me_acl();i.setPublicReadAccess(!0),t.setACL(i)}return t.set("original",e),t.save()}).done(function(e){return a.character.set("portrait",e),a.character.save()}).done(function(){a.$(".error").hide()}).fail(function(e){a.$(".error").html(_.escape(e.message)).show(),console.log(e.message)}).always(function(){a.delegateEvents(),e.mobile.loading("hide")}),!1},render:function(){return this.template=_.template(e("script#characterPortraitView").html())({character:this.character}),this.$el.find("div[role='main']").html(this.template),this.$el.enhanceWithin(),this}});return a});