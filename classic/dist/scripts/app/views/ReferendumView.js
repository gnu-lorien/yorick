define(["jquery","backbone","parse","backform","../forms/UserForm","text!../templates/profile-facebook-account.html","../helpers/PromiseFailReport","marionette","text!../templates/referendum/referendum.html","text!../templates/referendum/description.html","text!../templates/referendum/options.html","../models/ReferendumBallot"],function(e,t,a,r,l,o,n,s,i,u,m,d){var p=s.ItemView.extend({tagName:"div",template:_.template(u)}),f=s.ItemView.extend({tagName:"div",template:_.template(m),templateHelpers:function(){var e=this;return{referendum:e.model,ballot_message:e.ballot_message,ballot:e.ballot,patronagestatus:e.patronagestatus,ballots:e.ballots,users:e.users}},initialize:function(e){var t=this;t.ballot=e.ballot,t.patronagestatus=e.patronagestatus,t.ballots=e.ballots,t.users=e.users},events:{"click a":"cast_ballot"},cast_ballot:function(e){var t=this;e.preventDefault(),t.undelegateEvents();var r=t.$(e.target).attr("name");console.log(t.$(e.target).attr("name")),a.Cloud.run("vote_for_referendum",{referendum_id:t.model.id,ballot_option:r}).fail(function(e){t.ballot_message=e,console.error(e)}).then(function(e){t.ballot_message=e;var r=new a.Query("ReferendumBallot").equalTo("owner",t.model).equalTo("caster",a.User.current());return r.first()}).then(function(e){t.ballot=e}).always(function(){t.delegateEvents(),t.render()})}}),c=s.LayoutView.extend({el:"#referendum",template:_.template(i),regions:{description:"#referendum-description",options:"#referendum-options"},initialize:function(e){},setup:function(e){var t=this,a=e.referendum,r=e.ballot,l=e.ballots,o=e.patronagestatus,n=e.users;return t.render(),t.showChildView("description",new p({model:a})),t.showChildView("options",new f({model:a,ballot:r,patronagestatus:o,ballots:l,users:n})),t}});return c});