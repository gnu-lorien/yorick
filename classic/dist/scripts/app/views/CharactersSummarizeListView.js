define(["underscore","jquery","backbone","text!../templates/character-summarize-list-item.html","marionette","../models/Vampire","../models/Werewolf","backform","text!../templates/character-summarize-list-item-csv.html","text!../templates/character-summarize-list-item-csv-header-grouped.html"],function(e,t,a,l,i,r,n,o,s,c){var m=i.ItemView.extend({tagName:"li",className:"ul-li-has-thumb",template:e.template(l),initialize:function(e){this.mode=e.mode,this.name=e.name},templateHelpers:function(){var e=this;return{e:e.model,mode:e.mode,name:e.name}},events:{click:"clicked"},clicked:function(a){var l=this;a.preventDefault(),t.mobile.loading("show");var i=t(a.currentTarget),r=i.attr("backendId"),n=e.template(l.click_url)({character_id:r});window.location.hash=n},onRender:function(){this.$el.enhanceWithin()}}),u=i.ItemView.extend({tagName:"li",template:e.template(s),initialize:function(e){this.mode=e.mode,this.name=e.name,this.columnNames=e.columnNames},templateHelpers:function(){var e=this;return{e:e.model,mode:e.mode,name:e.name}}}),d=i.ItemView.extend({tagName:"li",template:e.template(c),initialize:function(e){this.mode=e.mode,this.name=e.name,this.columnNames=e.columnNames},templateHelpers:function(){var e=this;return{e:e.model,mode:e.mode,name:e.name,columnNames:e.columnNames}}}),h=i.CollectionView.extend({tagName:"ul",childView:m,childViewOptions:function(e,t){var a=this;return{mode:a.mode,name:a.name,columnNames:a.columnNames}},onRender:function(){var e=this;e.$el.attr("data-role","listview"),e.$el.attr("data-inset","true"),e.$el.attr("data-filter","true"),e.$el.attr("data-input","#troupes-summarize-characters-filter")},onDomRefresh:function(){}}),p=i.ItemView.extend({className:"ui-block-b",template:function(t){return e.template("<button><%= name %></button>")(t)},events:{click:"filterwith"},filterwith:function(){this.triggerMethod("filterwith",this.model)}}),f=(i.CollectionView.extend({className:"ui-grid-b ui-responsive",childView:p}),e.map(r.all_simpletrait_categories(),function(e){return{label:e[1],value:e[0]}})),g=e.map(n.all_simpletrait_categories(),function(e){return{label:e[1],value:e[0]}}),v=[{label:"Vampire",options:f},{label:"Werewolf",options:g}],b=o.Control.extend({defaults:{label:"",options:[],extraClasses:[]},template:e.template(['<label class="<%=Backform.controlLabelClassName%>"><%-label%></label>','<div class="<%=Backform.controlsClassName%>">','  <select class="<%=Backform.controlClassName%> <%=extraClasses.join(\' \')%>" name="<%=name%>" value="<%-value%>" <%=disabled ? "disabled" : ""%> <%=required ? "required" : ""%> >',"    <% for (var i=0; i < options.length; i++) { %>","      <% var optgroup = options[i] %>",'      <optgroup label="<%= optgroup.label %>">',"      <% for (var j=0; j < optgroup.options.length; j++) { %>","        <% var option = optgroup.options[j]; %>",'        <option value="<%-formatter.fromRaw(option.value)%>" <%=option.value === rawValue ? "selected=\'selected\'" : ""%> <%=option.disabled ? "disabled=\'disabled\'" : ""%>><%-option.label%></option>',"      <% } %>","      </optgroup>","    <% } %>","  </select>","</div>"].join("\n")),events:{"change select":"onChange","focus select":"clearInvalid"},formatter:o.JSONFormatter,getValueFromDOM:function(){return this.formatter.toRaw(this.$el.find("select").val(),this.model)}}),w=o.Form.extend({fields:[{name:"category",label:"Category",control:b,options:v},{name:"antecedence",label:"NPC, PC, Primary, or Secondary",control:"select",options:[{label:"All",value:"All"},{label:"NPC",value:"NPC"},{label:"PC of any type",value:"PC"},{label:"Primary PC",value:"Primary"},{label:"Secondary PC",value:"Secondary"}]},{name:"resulttype",label:"Which sort of results to show?",control:"select",options:[{label:"Only those with values in the category",value:"onlycat"},{label:"Only those with no values in the category",value:"nocat"},{label:"All",value:"all"}]},{name:"playable",label:"Only show playable characters",control:"checkbox"},{name:"format",label:"Format",control:"select",options:[{label:"Pretty",value:"pretty"},{label:"CSV",value:"csv"},{label:"CSV with Trait Grouping",value:"csvtraitgrouping"}]}]}),y=a.Model.extend({}),C=a.Collection.extend({model:y}),N=i.LayoutView.extend({el:"#troupe-summarize-characters-all > div[data-role='main']",regions:{sections:"#sections",list:"#troupe-summarize-characters-list"},childEvents:{filterwith:"filterwith"},filterwith:function(t){var a=this;a.list.currentView.mode=t.get("category");var l=e.find(r.all_simpletrait_categories(),function(e){return e[0]==t.get("category")});e.isUndefined(l)&&(l=e.find(n.all_simpletrait_categories(),function(e){return e[0]==t.get("category")})),a.list.currentView.name=l[1],a.list.currentView.columnNames=a.getColumnNames(t.get("category"));var i=t.get("format");e.startsWith(i,"pretty")?a.list.currentView.childView=m:e.startsWith(i,"csvtraitgrouping")?a.list.currentView.childView=d:a.list.currentView.childView=u;var o=function(a,l,i){var r=a.get("antecedence");e.isUndefined(r)&&(r="Primary");var n=t.get("antecedence");if(!e.startsWith(n,"All"))if(e.startsWith(n,"NPC")){if(!e.startsWith(r,"NPC"))return!1}else if(e.startsWith(n,"PC")){if(e.startsWith(r,"NPC"))return!1}else if(!e.startsWith(r,n))return!1;var o=t.get("resulttype");if(e.startsWith(o,"onlycat")){if(!a.has(t.get("category")))return!1;if(0==a.get(t.get("category")).length)return!1}else if(e.startsWith(o,"nocat")&&a.has(t.get("category")))return!1;return!(t.get("playable")&&!a.has("owner"))};a.list.currentView.filter=o,a.collection.reset(e.map(a.collection.models))},getColumnNames:function(t){var a=this;return e(a.collection.models).map("attributes."+t).flatten().map("attributes.name").without(void 0).sortBy().uniq(!0).value()},setup:function(){var e=this,t=e.options||{};new C;return e.filterOptions=new a.Model({playable:!0,category:"attributes",antecedence:"PC",resulttype:"onlycat",format:"pretty"}),e.listenTo(e.filterOptions,"change",e.filterwith),e.showChildView("sections",new w({model:e.filterOptions}),t),e.showChildView("list",new h({collection:e.collection}),t),this.$el.enhanceWithin(),e.filterOptions.trigger("change",e.filterOptions),e}});return N});