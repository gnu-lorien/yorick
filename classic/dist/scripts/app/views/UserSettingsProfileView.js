define(["jquery","backbone","parse","backform","../forms/UserForm","text!../templates/profile-facebook-account.html","../helpers/PromiseFailReport","../helpers/InjectAuthData","marionette","../views/PatronagesView","../collections/Patronages","text!../templates/user-settings-profile.html","text!../templates/paypal-button.html"],function(e,t,n,a,i,r,o,s,l,u,c,m,d){var f=l.ItemView.extend({tagName:"form",template:_.template(""),initialize:function(){var r=this;r.errorModel=new t.Model,this.form=new i({errorModel:r.errorModel,model:n.User.current()||new t.Model,events:{change:function(e){e.preventDefault(),this.$("button[name=submit]").removeAttr("disabled");var t=this.fields.get("submit");"success"==t.get("status")&&(t.set({status:"",message:"",disabled:!1}),this.$el.enhanceWithin())},submit:function(t){var n=this;return t.preventDefault(),e.mobile.loading("show"),n.undelegateEvents(),n.model.errorModel.clear(),s(n.model),n.model.save().then(function(){n.fields.get("submit").set({status:"success",message:"Successfully Updated",disabled:!0}),n.$el.enhanceWithin()},function(e){n.fields.get("submit").set({status:"error",message:_.escape(e.message),disabled:!1}),n.$el.enhanceWithin()}).always(function(){e.mobile.loading("hide"),n.delegateEvents()}),!1}}}),r.form.fields.add(new a.Field({name:"submit",label:"Update",control:"button",disabled:!0,id:"submit"}))},onRender:function(){if(this.form.model!==n.User.current()){var e=this.form.model.errorModel;this.form.model=n.User.current(),this.form.model.errorModel=e}return this.form.setElement(this.$el),this.form.render(),this.$el.enhanceWithin(),this}}),h=l.ItemView.extend({tagName:"div",template:_.template(r),events:{"click #facebook-unlink":"unlink","click #facebook-link":"link"},unlink:function(e){var t=this;e.preventDefault(),t.undelegateEvents(),n.User.current().set("authData",{facebook:null}),n.User.current().save().then(function(){t.delegateEvents(),t.render()}).fail(o)},link:function(e){var t=this;e.preventDefault(),t.undelegateEvents(),n.FacebookUtils.link(n.User.current(),"email").then(function(e){return hello("facebook").api("/me")}).then(function(e){t.delegateEvents(),t.render();var a=n.User.current();return a.has("email")||a.set("email",e.email),a.has("realname")||a.set("realname",e.name),s(a),a.save()}).fail(o)},onRender:function(){this.$el.enhanceWithin()}}),p=l.ItemView.extend({tagName:"div",template:_.template(d),templateHelpers:{userid:function(){return n.User.current().id}}}),g=l.ItemView.extend({template:function(e){return _.template("The one: <%= attributes.name %>")(e)}}),b=l.CollectionView.extend({tagName:"div",childView:g}),w=l.LayoutView.extend({el:"#user-settings-profile",template:_.template(m),regions:{profile:"#user-settings-profile-abs-form",facebook:"#facebook-account-linking",patronage:"#usp-patronage-list-region",paypal:"#usp-paypal-button",roles:"#user-roles-available"},initialize:function(e){var t=this;t.patronages=new c},setup:function(){var e=this,a=e.options||{};e.render(),e.showChildView("profile",new f,a),e.showChildView("facebook",new h,a),e.showChildView("paypal",new p,a),e.showChildView("patronage",new u({el:"#usp-patronage-list",collection:e.patronages,back_url_base:"#profile/"}),a);var i=new t.Collection,r=new n.Query(n.Role);return r.each(function(e){var t=e.getUsers(),a=t.query();return a.equalTo("objectId",n.User.current().id),a.each(function(t){i.add(e)}).fail(function(t){console.log("Failed in promise for "+e.get("name"))})}).fail(o),e.showChildView("roles",new b({collection:i}),a),e.patronages.query.equalTo("owner",n.User.current()),e.patronages.fetch(),e}});return w});