define(["jquery","backbone","backform","../models/Troupe","../forms/TroupeForm"],function(e,s,t,o,r){var n=s.View.extend({initialize:function(){var s=this;_.bindAll(this,"render"),s.form=new r({el:"#troupe-new-form",model:new o,events:{submit:function(t){t.preventDefault();var o;e.mobile.loading("show"),this.model.save().then(function(e){console.log("Saved the troupe"),o=e;var s=new Parse.Query(Parse.Role);return s.equalTo("name","Administrator"),s.first()}).then(function(e){var s=new Parse.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!1),s.setRoleReadAccess("Administrator",!0),s.setRoleWriteAccess("Administrator",!0);var t=new Parse.Role("LST_"+o.id,s);t.getRoles().add(e);var r=new Parse.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!1),r.setRoleReadAccess("Administrator",!0),r.setRoleWriteAccess("Administrator",!0),r.setRoleReadAccess(t,!0),r.setRoleWriteAccess(t,!0);var n=new Parse.Role("AST_"+o.id,r);n.getRoles().add(e);var a=new Parse.ACL;a.setPublicReadAccess(!0),a.setPublicWriteAccess(!1),a.setRoleReadAccess("Administrator",!0),a.setRoleWriteAccess("Administrator",!0),a.setRoleReadAccess(t,!0),a.setRoleWriteAccess(t,!0),a.setRoleReadAccess(n,!0),a.setRoleWriteAccess(n,!0);var i=new Parse.Role("Narrator_"+o.id,a);return i.getRoles().add(e),Parse.Object.saveAll([t,n,i])}).then(function(e){console.log("Saved roles");var s=e[0],t=e[1],o=e[2];return t.getRoles().add(s),o.getRoles().add([s,t]),Parse.Object.saveAll([s,t,o])}).then(function(e){var s=e[0],t=o.getACL();return t.setRoleReadAccess(s,!0),t.setRoleWriteAccess(s,!0),o.save()}).then(function(e){console.log("Saved troupe again"),s.render(),window.location.hash="#troupe/"+e.id}).fail(function(e){console.log("Failed to save troupe "+e.message),window.location.hash="#administration"}).always(function(){e.mobile.loading("hide")})}}}),s.form.fields.add(new t.Field({control:"button",label:"Add New"}))},render:function(){var e=this;return e.form.model=new o,e.form.render(),this.$el.enhanceWithin(),this}});return n});