define(["underscore","jquery","backbone","marionette","parse","moment","text!../templates/character-print-view.html","text!../templates/character-history-selected-view.html","text!../templates/character-history-view.html","../helpers/VampirePrintHelper","../views/CharacterPrintView"],function(e,t,i,r,n,d,o,a,s,l,c){var h=r.ItemView.extend({template:e.template(s),templateHelpers:function(){var e=this;return{character:this.model,logs:this.model.recorded_changes.models,idForPickedIndex:e.picked.get("value")}},modelEvents:{saved:"update_then_render"},events:{change:"update_picked"},initialize:function(t){this.picked=t.picked,this.override=t.override,e.bindAll(this,"templateHelpers")},update_picked:function(t){var i=this,r=e.parseInt(this.$(t.target).val());i.picked.set("value",r);var n=this.$("#history-changes-"+r).val(),d=e.chain(i.model.recorded_changes.models).takeRightWhile(function(e){return e.id!=n}).reverse().value(),o=i.model.get_transformed(d);o.transform_description=[],i.override.set("character",o)},update_then_render:function(){var e=this;e.model.update_recorded_changes().then(function(){e.render()})},onRender:function(){this.$el.enhanceWithin()}}),m=r.ItemView.extend({template:e.template(a),templateHelpers:function(){var e=this;return{character:this.model,logs:this.model.recorded_changes.models,format_entry:this.format_entry,idForPickedIndex:e.picked.get("value")}},modelEvents:{add:"render",reset:"render"},initialize:function(t){this.picked=t.picked,this.listenTo(this.picked,"change",e.debounce(this.render,100,{trailing:!0})),e.bindAll(this,"templateHelpers")},format_entry:function(t,i){if(e.isUndefined(t))return console.log("Undefined log"),"Undefined log";if(t.get(i))return t.get(i);var r=t[i];return e.isDate(r)?d(r).format("lll"):r},onRender:function(){this.$el.enhanceWithin()}}),p=r.LayoutView.extend({tagName:"div",regions:{main:"#history-main",viewing:"#history-viewing",sheet:"#history-sheet"},register:function(e){var t=this,r=n.Promise.as([]);return e!=t.model&&(t.model=e,t.picked=new i.Model({value:0}),t.override=new i.Model({character:null}),r=t.model.get_recorded_changes().then(function(){t.picked.set("value",t.model.recorded_changes.models.length-1),t.showChildView("main",new h({model:t.model,picked:t.picked,override:t.override})),t.showChildView("viewing",new m({model:t.model,picked:t.picked}));var e=new c;e=e.setup({character:t.model,override:t.override}),t.showChildView("sheet",e)})),r.then(function(){n.Promise.as(t)})},onRender:function(){this.$el.enhanceWithin()}});return p});