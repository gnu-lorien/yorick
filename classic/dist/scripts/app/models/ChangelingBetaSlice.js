define(["underscore","jquery","parse","../models/SimpleTrait","../models/VampireChange","../models/VampireCreation","../collections/VampireChangeCollection","../collections/ExperienceNotationCollection","../models/ExperienceNotation","../helpers/BNSCTDBS_ChangelingCostsFetcher","../helpers/PromiseFailReport","../helpers/ExpirationMixin","../helpers/UserWreqr","../models/Character"],function(t,e,r,n,i,a,s,c,o,u,_,l,d,p){var f=[["attributes","Attributes","Attributes"],["focus_physicals","Physical Focus","Attributes"],["focus_mentals","Mental Focus","Attributes"],["focus_socials","Social Focus","Attributes"],["health_levels","Health Levels","Expended"],["willpower_sources","Willpower","Expended"],["skills","Skills","Skills"],["lore_specializations","Lore Specializations","Skills"],["academics_specializations","Academics Specializations","Skills"],["drive_specializations","Drive Specializations","Skills"],["linguistics_specializations","Languages","Skills"],["ctdbs_arts","Arts","Arts"],["ctdbs_arts_affinities_links","Arts Affinities","Arts"],["ctdbs_realms","Realms","Arts"],["ctdbs_backgrounds","Backgrounds","Backgrounds"],["ctdbs_holdings_specializations","Holdings Specializations","Backgrounds"],["contacts_specializations","Contacts Specializations","Backgrounds"],["allies_specializations","Allies Specializations","Backgrounds"],["influence_elite_specializations","Influence: Elite","Backgrounds"],["influence_underworld_specializations","Influence: Underworld","Backgrounds"],["ctdbs_merits","Merits","Merits and Flaws"],["ctdbs_flaws","Flaws","Merits and Flaws"]],h=["archetype","ctdbs_kith","ctdbs_fealty_court","ctdbs_noble_house","ctdbs_kith_group_type","antecedence"],g=["Archetype","Kith","Court","House",function(t){return"Group"},"Primary, Secondary, or NPC"],m=["ctdbs_merits","ctdbs_flaws"],b=t.extend({get_sum_creation_categories:function(){return m},update_creation_rules_for_changed_trait:function(e,n,i){var a=this;return(t.contains(["ctdbs_merits","ctdbs_flaws"],e)||i)&&t.contains(["ctdbs_flaws","ctdbs_merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","ctdbs_arts","ctdbs_backgrounds"],e)?r.Object.fetchAllIfNeeded([a.get("creation")]).then(function(s){var c=s[0],o=e+"_"+i+"_remaining",u=e+"_"+i+"_picks";if(c.addUnique(u,n),t.contains(["ctdbs_merits","ctdbs_flaws"],e)){var _=t.sum(c.get(u),"attributes.value");c.set(o,7-_)}else c.increment(o,-1);return r.Promise.as(a)}):r.Promise.as(a)},ensure_creation_rules_exist:function(){var t=this;if(t.has("creation"))return r.Object.fetchAllIfNeeded([t.get("creation")]).then(function(){return r.Promise.as(t)},function(t){console.log("ensure_creation_rules_exist",t)});var e=new a({owner:t,completed:!1,concept:!1,archetype:!1,clan:!1,attributes:!1,focuses:!1,skills_4_remaining:1,skills_3_remaining:2,skills_2_remaining:3,skills_1_remaining:4,ctdbs_backgrounds_3_remaining:1,ctdbs_backgrounds_2_remaining:1,ctdbs_backgrounds_1_remaining:1,attributes_7_remaining:1,attributes_5_remaining:1,attributes_3_remaining:1,ctdbs_arts_1_remaining:3,focus_mentals_1_remaining:1,focus_socials_1_remaining:1,focus_physicals_1_remaining:1,ctdbs_merits_0_remaining:7,ctdbs_flaws_0_remaining:7,phase_1_finished:!1,initial_xp:30,phase_2_finished:!1});return e.save().then(function(e){return t.set("creation",e),t.add_experience_notation({reason:"Character Creation XP",alteration_earned:30,earned:30})}).then(function(e){return r.Promise.as(t)})},fetch_all_creation_elements:function(){var e=this;return e.ensure_creation_rules_exist().then(function(){var n=e.get("creation"),i=["ctdbs_flaws","ctdbs_merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","ctdbs_backgrounds","ctdbs_arts"],a=[];return t.each(i,function(e){t.each(t.range(-1,10),function(r){var i=e+"_"+r+"_picks";a=t.union(n.get(i),a)})}),a=t.chain(a).flatten().without(void 0).filter(function(t){return t.id}).value(),r.Object.fetchAllIfNeeded(a).then(function(){return r.Promise.as(e)})})},all_simpletrait_categories:function(){return f},all_text_attributes:function(){return h},all_text_attributes_pretty_names:function(){return g},_raw_seeming:function(){var e,r=this;return t.each(r.get("ctdbs_backgrounds"),function(t){"Seeming"==t.get_base_name()&&(e=t.get("value"))}),e},seeming:function(){return this._raw_seeming()||0},has_seeming:function(){return!t.isUndefined(this._raw_seeming())},realms:function(){var t=this;return t.get("ctdbs_realms")},calculate_trait_cost:function(t){var e=this;return e.Costs.calculate_trait_cost(e,t)},calculate_trait_to_spend:function(t){var e=this,r=e.Costs.calculate_trait_cost(e,t),n=t.get("cost")||0;return r-n},calculate_total_cost:function(){var e=this,n=["skills","ctdbs_backgrounds","ctdbs_arts","attributes","ctdbs_merits"],i={},a=t.chain(n).map(function(t){return e.get(t)}).flatten().without(void 0).value();return r.Object.fetchAllIfNeeded(a).then(function(n){return t.each(n,function(t){i[t.get("category")+"-"+t.get("name")]={trait:t,cost:e.calculate_trait_cost(t)}}),r.Promise.as(i)})},max_trait_value:function(t){return"skills"==t.get("category")?10:20},initialize_costs:function(){var e=this;return t.isUndefined(e.Costs)?u().then(function(t){return e.Costs=t,r.Promise.as(e)}):r.Promise.as(e)},get_arts_affinities:function(){var t=this;return t.Costs.get_arts_affinities(t)},_unpick_previous_arts:function(e){var n=this;return n._updateTraitWrapper=n._updateTraitWrapper||r.Promise.as(),0==e.length?n._updateTraitWrapper:(t.chain(n.get_arts_affinities()).each(function(e){var r=t.find(n.get("ctdbs_arts"),function(t){return t.get("name")==e});r&&(console.log("Calling unpick_from in _unpick_previous_arts "+r.get("name")),n.unpick_from_creation("ctdbs_arts",r.id,1))}).value(),n._updateTraitWrapper)},update_text:function(e,n){var i=this;return"ctdbs_kith"!=e?i.constructor.__super__.update_text.apply(i,[e,n]):(i._updateTraitWrapper=i._updateTraitWrapper||r.Promise.as(),i._updateTraitWrapper=i._updateTraitWrapper.always(function(){return console.log("Fetching all arts if needed"),r.Object.fetchAllIfNeeded(i.get("ctdbs_arts")||[])}),i._unpick_previous_arts(i.get_arts_affinities()),i._updateTraitWrapper=i._updateTraitWrapper.then(function(){return console.log("Saving the changeling."),i.save()}),i._updateTraitWrapper=i._updateTraitWrapper.then(function(){return console.log("Applying the original update text"),i.constructor.__super__.update_text.apply(i,[e,n])}),console.log("About to add affinities for kith "+n),t.each(i.Costs.get_arts_affinities_for_kith(n),function(t){console.log("Updating trait for new art affinity "+t),i.update_trait(t,1,"ctdbs_arts",1)}),i._updateTraitWrapper=i._updateTraitWrapper.then(function(){return console.log("Saving creation after doing the Changeling update text"),i.progress("Saving the creation after updating Arts for Kith "+n),i.get("creation").save()}),i._updateTraitWrapper)},unpick_text:function(t){var e=this;return e._updateTraitWrapper=e._updateTraitWrapper||r.Promise.as(),e._updateTraitWrapper=e._updateTraitWrapper.always(function(){return e.constructor.__super__.unpick_text.apply(e,[t])}),e._updateTraitWrapper}},l);t.extend(b,p);var v=r.Object.extend("Vampire",b);v.get_character=function(e,n,i){if(t.isUndefined(i)&&(i={_character:null}),n=n||[],t.isString(n)&&(n=[n]),null===i._character){var a=new r.Query(v);return a.include("portrait"),a.include("owner"),a.include("ctdbs_backgrounds"),a.include("ctdbs_arts_affinities_links"),a.include("ctdbs_realms"),a.get(e).then(function(t){return i._character=t,v.get_character(e,n,i)})}if(i._character.id!=e)return i._character.save().then(function(){return i._character=null,v.get_character(e,n,i)});if("all"==n&&(n=t.result(i._character,"all_simpletrait_categories",[]),n=t.map(n,function(t){return t[0]})),0!==n.length){var s=t.chain(n).map(function(t){return i._character.get(t)}).flatten().without(void 0).filter(function(t){return t.id}).value();return r.Object.fetchAllIfNeeded(s).done(function(){return v.get_character(e,[],i)})}return i._character.ensure_creation_rules_exist().then(function(t){return i._character.initialize_costs()}).then(function(t){return i._character.initialize_troupe_membership()})};var k=function(r){t.isUndefined(e)||t.isUndefined(e.mobile)||t.isUndefined(e.mobile.loading)?console.log("Progress: "+r):e.mobile.loading("show",{text:r,textVisible:!0})};return v.create=function(e){var n,i=new v,a=new r.ACL;return a.setPublicReadAccess(!1),a.setPublicWriteAccess(!1),a.setWriteAccess(r.User.current(),!0),a.setReadAccess(r.User.current(),!0),a.setRoleReadAccess("Administrator",!0),a.setRoleWriteAccess("Administrator",!0),i.setACL(a),k("Fetching patronage status"),d.get_latest_patronage(r.User.current()).then(function(n){var a={name:e,type:"ChangelingBetaSlice",owner:r.User.current(),change_count:0};return n&&t.extend(a,{expiresOn:n.get("expiresOn")}),k("Saving base character"),i.save(a)}).then(function(){return k("Fetching character from server"),v.get_character(i.id)}).then(function(t){return n=t,k("Adding Healthy"),n.update_trait("Healthy",3,"health_levels",3,!0)}).then(function(){return k("Adding Injured"),n.update_trait("Injured",3,"health_levels",3,!0)}).then(function(){return k("Adding Incapacitated"),n.update_trait("Incapacitated",3,"health_levels",3,!0)}).then(function(){return k("Adding Willpower"),n.update_trait("Willpower",6,"willpower_sources",6,!0)}).then(function(){return k("Done!"),r.Promise.as(n)})},v.create_test_character=function(t){var t=t||"",e="karmacharactertestwerewolf"+t+Math.random().toString(36).slice(2);return v.create(e)},v.all_simpletrait_categories=function(){return f},v.all_text_attributes=function(){return h},v.all_text_attributes_pretty_names=function(){return g},v});