define(["underscore","jquery","backbone","parse","text!../templates/character-summarize-list-item.html","marionette","backform","text!../templates/character-summarize-list-item-csv.html","text!../templates/character-summarize-list-item-csv-header-grouped.html","../helpers/PromiseFailReport","papaparse"],function(e,t,n,o,a,r,i,s,l,c,u){var d="",m=i.Form.extend({fields:[{control:"button",label:"Update Changes to Server"},{name:"descriptiondata",label:"Descriptions",control:"textarea"}],events:{submit:function(t){var n=this;t.preventDefault();var a=u.parse(n.model.get("descriptiondata"),{header:!0});if(console.log(a),0!=a.errors.length)return void console.log(JSON.stringify(a.errors));var r=e.map(a.data,function(t,a){var r,i=new o.Query(d).equalTo("category",t.category).equalTo("name",t.name);return i.first().then(function(a){a?console.log("Found existing object for "+t.category+" "+t.name):(a=new o.Object(n.ruleName,{name:t.name,category:t.category}),console.log("Didn't find existing object for "+t.category+" "+t.name));var i=new o.ACL;i.setPublicReadAccess(!0),i.setPublicWriteAccess(!1),i.setRoleReadAccess("Administrator",!0),i.setRoleWriteAccess("Administrator",!0),a.setACL(i);var s=e.omit(t,function(t){return!!e.includes(["name","category"],t)||""==t});return e.each(s,function(t,n){"order"==n?a.set(n,e.parseInt(t)):a.set(n,t)}),console.log(a.attributes),r=" "+a.id+" "+a.attributes.name,a.save()}).fail(function(e){console.log(e),console.log("Error on saving disguy?"+r)})});o.Promise.when(r).then(function(){console.log(JSON.stringify(arguments)),console.log("Saved all of that")}).then(function(){console.log("Saved all of that")}).fail(c)}}}),f=i.Form.extend({fields:[{name:"category",label:"Category",control:"select",options:[{label:"None",value:"None"}]}]}),g=r.LayoutView.extend({el:"#administration-descriptions > div[data-role='main']",regions:{sections:"#descriptions-sections",list:"#administration-descriptions-list"},childEvents:{filterwith:"filterwith",submit:"submit"},filterwith:function(t){var n,a=this;n="All"==t.get("category")?new o.Query(d):new o.Query(d).equalTo("category",t.get("category"));var r=[];return n.each(function(t){r.push(e.omit(t.attributes,"ACL"))}).then(function(){r=e(r).sortByAll(["category","order","name"]).value();var t=e(r).map(function(t){return e.keys(t)}).tap(function(e){console.log(e)}).flatten().uniq().value();a.data.set("descriptiondata",u.unparse({fields:t,data:r}))}).fail(c)},getColumnNames:function(t){var n=this;return e(n.collection.models).map("attributes."+t).flatten().map("attributes.name").without(void 0).sortBy().uniq(!0).value()},setup:function(){var e=this,t=e.options||{};return e.filterOptions=new n.Model({playable:!0,category:"attributes",antecedence:"PC",resulttype:"onlycat",format:"pretty"}),e.data=new n.Model({descriptiondata:"Nothing here yet"}),e.listenTo(e.filterOptions,"change",e.filterwith),e.showChildView("sections",new f({model:e.filterOptions}),t),e.showChildView("list",new m({model:e.data}),t),this.$el.enhanceWithin(),e},update_rule_name:function(e){d=e},update_categories:function(){var t=this,n=new o.Query(d);n.select("category");var a={};return n.each(function(e){a[e.get("category")]=1}).then(function(){console.log(a);var n=t.sections.currentView,r=n.fields.models[0],i=e.map(a,function(e,t){return{label:t,value:t}});return i=e.sortBy(i,"label"),i.push({label:"All",value:"All"}),r.set("options",i),o.Promise.as(n.render())})}});return g});