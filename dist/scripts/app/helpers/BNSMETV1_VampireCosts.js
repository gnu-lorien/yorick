define(["underscore","parse","../collections/BNSMETV1_ClanRules"],function(t,e,n){var i=e.Object.extend("VampireCosts",{initialize:function(){var t=this;try{return t.ClanRules=BNSMETV1_ClanRules,e.Promise.as(t.ClanRules)}catch(i){return t.ClanRules=new n,t.ClanRules.fetch()}},get_in_clan_disciplines:function(e){var n=this,i=n.ClanRules.get_in_clan_disciplines(e),a=t.map(e.get("extra_in_clan_disciplines"),"attributes.name");return i=[].concat(i,a)},discipline_is_in_clan:function(e,n){var i=this,a=i.ClanRules.get_in_clan_disciplines(e),_=t.map(e.get("extra_in_clan_disciplines"),"attributes.name");return a=[].concat(a,_),[]!=a&&t.any(a,function(e){return!!t.eq(e,n.get_base_name())||!!t.eq(e,n.get("name"))})},get_cost_table:function(e){return t.map(t.range(1,10),function(t){return t*e})},get_cost_on_table:function(e,n){return t.chain(e).take(n).sum().value()},get_trait_cost_on_table:function(t,e){var n=this,i=e.get("value"),a=e.get("free_value")||0,_=n.get_cost_on_table(t,i),s=n.get_cost_on_table(t,a);return _-s},get_generation_cost_table:function(){var t=this,e=t.get_cost_table(2);return e[0]=1,e},calculate_trait_cost:function(t,e){var n=this,i=e.get("category"),a=e.get("name"),_=e.get("value"),s=e.get("free_value")||0,r=_-s;if("attributes"==i)return 3*r;if("disciplines"==i&&n.discipline_is_in_clan(t,e))return n.get_trait_cost_on_table(n.get_cost_table(3),e);if("humanity"==i||"paths"==i)return 10*r;if("merits"==i)return r;if("flaws"==i)return r*-1;if("rituals"==i)return 2*r;var l,c,o,u=t.generation(),g=9999,b=99999,f=99999,d=99999;return"backgrounds"==i?(l="Generation"==a?n.get_generation_cost_table():1==u?n.get_cost_table(1):n.get_cost_table(2),n.get_trait_cost_on_table(l,e)):"skills"==i?(c=1==u?n.get_cost_table(1):n.get_cost_table(2),n.get_trait_cost_on_table(c,e)):"disciplines"==i?(o=u<5?n.get_cost_table(4):n.get_cost_table(5),n.get_trait_cost_on_table(o,e)):"techniques"==i?(u<3?g=12:3==u&&(g=20),r*g):"elder_disciplines"==i?(u>=3&&(b=18),u>=5?f=30:u>=3&&(f=24),n.discipline_is_in_clan(t,e)?r*b:r*f):"luminary_disciplines"==i?(u>=5&&n.discipline_is_in_clan(t,e)&&(d=24),r*d):void 0}});return i});